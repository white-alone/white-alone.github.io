<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="github.white-alone.com"><title>OpenBTS使用指南 | White-Alone</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 4.2.1"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">OpenBTS使用指南</h1><a id="logo" href="/.">White-Alone</a><p class="description">蝴蝶再美 终究飞不过沧海</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">OpenBTS使用指南</h1><div class="post-meta">2019-01-18<span> | </span><span class="category"><a href="/categories/Radio/">Radio</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" href="/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/#vcomment"><span class="valine-comment-count" data-xid="/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/"></span><span> 条评论</span></a><div class="post-content"><p><strong><font color=red>这是15年翻译的官方文档，之后会陆续放出以前翻译的一些文档，以及做的一些笔记给大家参考，转载请注明出处！</font></strong></p>
<p><strong><font color=red>另注：此文仅供学习参考，请勿用于非法行为！测试建议在屏蔽室进行，或者在屏蔽试验箱中进行，切勿影响正常通信！！！</font></strong></p>
<hr>
<h1 id="初始化配置和测试"><a href="#初始化配置和测试" class="headerlink" title="初始化配置和测试"></a>初始化配置和测试</h1><hr>
<h2 id="0x110-启动服务"><a href="#0x110-启动服务" class="headerlink" title="0x110 启动服务"></a>0x110 启动服务</h2><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">start</span> asterisk</span><br><span class="line"><span class="literal">start</span> sipauthserve</span><br><span class="line"><span class="literal">start</span> smqueue</span><br><span class="line"><span class="literal">start</span> openbts</span><br></pre></td></tr></table></figure>

<h2 id="0x120-进入控制台"><a href="#0x120-进入控制台" class="headerlink" title="0x120 进入控制台"></a>0x120 进入控制台</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/OpenBTS/</span>OpenBTSCLI</span><br></pre></td></tr></table></figure>
<h2 id="0x130-修改Band和ARFCN"><a href="#0x130-修改Band和ARFCN" class="headerlink" title="0x130 修改Band和ARFCN"></a>0x130 修改Band和ARFCN</h2><p>Band 频段：全世界共有4个GSM频段，分别为850,900,1800,1900<br>ARFCN 绝对无线频道编号：每个无线频段都有100多种ARFCN可以用，每个ARFCN对应一个频率，选择正确的频段和频率，可以避免干扰<br>这些配置都在GSM.Radio中，用config命令可以查看：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">GSM</span><span class="selector-class">.Radio</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.ARFCNs</span> 1     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.Band</span> 850</span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.C0</span> 166</span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.MaxExpectedDelaySpread</span> 4     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.PowerManager</span><span class="selector-class">.MaxAttenDB</span> 10     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.PowerManager</span><span class="selector-class">.MinAttenDB</span> 0     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.RSSITarget</span> <span class="selector-tag">-50</span>     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.SNRTarget</span> 10     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>
<p>频段900，ARFCN是C0的参数118，也可以不是用这些配置，在一般情况下，美国用850和1900，世界其他国家用900和1800，具体在维基百科可以看到<br>低频率覆盖范围更广，如果当地监管机构分配了频段和ARFCN，那就必须遵守规定。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Radio.Band 900</span><br><span class="line">GSM.Radio.Band changed <span class="keyword">from</span> <span class="string">"850"</span> <span class="keyword">to</span> <span class="string">"900"</span></span><br><span class="line">WARNING: GSM.Radio.C0 (166) falls outside the valid range of ARFCNs 1-124 <span class="keyword">for</span> GSM.Radio.Band (900)</span><br><span class="line">GSM.Radio.Band is static; change takes effect on restart</span><br><span class="line"></span><br><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Radio.C0 118  </span><br><span class="line">GSM.Radio.C0 changed <span class="keyword">from</span> <span class="string">"166"</span> <span class="keyword">to</span> <span class="string">"118"</span></span><br><span class="line">GSM.Radio.C0 is static; change takes effect on restart</span><br></pre></td></tr></table></figure>
<p>修改频段必须要与ARFCN匹配，或者两个都改，改完以后需要重启服务：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; <span class="keyword">restart</span></span><br><span class="line">OpenBTS has been shut down <span class="keyword">or</span> restarted.</span><br><span class="line">You will need <span class="keyword">to</span> <span class="keyword">restart</span> OpenBTSCLI <span class="keyword">after</span> it restarts.</span><br></pre></td></tr></table></figure>

<h2 id="0x140-调整信号增益"><a href="#0x140-调整信号增益" class="headerlink" title="0x140 调整信号增益"></a>0x140 调整信号增益</h2><p>需要修改GSM.Radio.RxGain的参数，如果信号增益太大，会导致设备无法工作，一般设置为最小25：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; devconfig GSM.Radio.RxGain <span class="number">25</span></span><br><span class="line">GSM.Radio.RxGain changed <span class="keyword">from</span> <span class="string">"30"</span> <span class="keyword">to</span> <span class="string">"25"</span></span><br><span class="line">GSM.Radio.RxGain <span class="keyword">is</span> static; change takes effect <span class="keyword">on</span> restart</span><br></pre></td></tr></table></figure>
<p>或者直接使用rxgain命令调，可以不用重启：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; rxgain <span class="number">25</span></span><br><span class="line">current RX gain <span class="keyword">is</span> <span class="number">30</span> dB</span><br><span class="line">new RX gain <span class="keyword">is</span> <span class="number">25</span> dB</span><br></pre></td></tr></table></figure>
<p>这时候，在手机中手动搜索运营商可以搜到 <code>Test PLMN 1-1</code></p>
<p>GSM中，一般同时使用两个频段，方便手机同时具备上行和下行链路，也就是全双工，具体哪个频段可以设置 <code>ARFCN</code></p>
<p>如果手机可以搜索到基站，就表明网络状态良好，但如果有较强的无线干扰，也就是噪声干扰俗称底噪，手机和基站的链路就可能会有问题。</p>
<p>可以用<code>noise</code>命令检查噪声强度：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; noise</span><br><span class="line">noise RSSI is -60 dB wrt full scale</span><br><span class="line">MS RSSI target is -50 dB wrt full scale</span><br><span class="line"><span class="symbol">WARNING: </span>the current noise level is approaching the MS RSSI target, uplink connectivity will be extremely limited.</span><br></pre></td></tr></table></figure>
<p>如果不调节rxgain，可以得到这样结果，实际上在使用时会发现，手机如果距离太近，也无法接入系统。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; noise    </span><br><span class="line">noise RSSI <span class="keyword">is</span> <span class="number">-71</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line">MS RSSI target <span class="keyword">is</span> <span class="number">-50</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line"><span class="keyword">INFO</span>: the <span class="keyword">current</span> noise <span class="keyword">level</span> <span class="keyword">is</span> acceptable.</span><br></pre></td></tr></table></figure>
<p>表示检测到的背景噪声RSSI信号强度为<code>-71dB</code>，这个数值越小表明底噪越少。配置的RSSI信号强度<code>为-50dB</code>，也就是说，基站所能提供的最高信号强度为 <code>21 dB</code>。一个好的差值意味着上行链路质量不错。两个数据的差值不同反馈信息也不同，如果差值小于<code>10db</code>，那么就会像前一个反馈的警告信息，提示噪声干扰强度已经接近所配的RSSI，上行链路质量非常有限。如果差值小于<code>0db</code>，会有警告提示噪声干扰比配置的RSSI信号还强，无法建立上行链路。</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; noise </span><br><span class="line">noise RSSI is -36 dB wrt full scale</span><br><span class="line">MS RSSI target is -50 dB wrt full scale</span><br><span class="line"><span class="symbol">WARNING: </span>the current noise level exceeds the MS RSSI target, uplink connectivity will be impossible.</span><br></pre></td></tr></table></figure>
<p>如果出现了这些警告提示，就需要想办法降低噪声干扰或者加大基站发射功率。</p>
<p><strong><font color=red>在以后的使用中，如果出现手机能搜到基站却无法连接的问题，首先检查下底噪，即使配置文件没做任何改变，但环境的底噪随时都会有变化。</font></strong></p>
<h2 id="0x150-如何减小底噪"><a href="#0x150-如何减小底噪" class="headerlink" title="0x150 如何减小底噪"></a>0x150 如何减小底噪</h2><p>如果基站没有配置成频率双工器，那么上行链路的噪声源可能来自于下行链路。如果没有适当的双工过滤，下行链路通常都是不论是频率还是空间距离最靠近上行链路的。不过，即使没有双工器，还是有一些办法可以降低下行链路对上行链路的噪声干扰。</p>
<h3 id="0x151-天线方向"><a href="#0x151-天线方向" class="headerlink" title="0x151 天线方向"></a>0x151 天线方向</h3><p>双工器的作用就是调整天线，让信号不那么容易影响对方，所以如果用的普通的塑料弯折天线，就将天线弯折一下，垂直成90度脚，这样天线的型号辐射图就是互相垂直的：</p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445687.png" alt=""></p>
<p>如果天线是互相平行的，信号可以很容易的从发射天线干扰接收天线，但当天线形成90度直角以后，信号的发射和接收在不同的平面。可以通过调整天线角度观察底噪的变化，这么简单的调节可以降低多达<code>10db</code>的底噪。</p>
<h3 id="0x152-下行链路的接收灵敏度"><a href="#0x152-下行链路的接收灵敏度" class="headerlink" title="0x152 下行链路的接收灵敏度"></a>0x152 下行链路的接收灵敏度</h3><p>再就是降低从发射天线到接收天线的信号强度。如果接收灵敏度比发射信号强度还高，降低接收灵敏度是很有效的。降低接收灵敏度可以清掉太强的上行信号。不过，降低接收灵敏度，会减小基站信号覆盖范围，在实验室环境可能看不出来。用<code>power</code>命令可以查看接收灵敏度。</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; <span class="built_in">power</span> <span class="number">0</span></span><br><span class="line">current downlink <span class="built_in">power</span> <span class="number">0</span> <span class="built_in">dB</span> wrt full scale</span><br></pre></td></tr></table></figure>
<p>当前最大接收灵敏度为<code>0db</code>，如果要降低灵敏度，比如降低<code>20db</code>，执行命令：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; <span class="built_in">power</span> <span class="number">20</span></span><br><span class="line">current downlink <span class="built_in">power</span> -<span class="number">20</span> <span class="built_in">dB</span> wrt full scale</span><br></pre></td></tr></table></figure>
<p>用<code>noise</code>命令可以看出明显的差别：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; power <span class="number">0</span></span><br><span class="line"><span class="keyword">current</span> downlink power <span class="number">0</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line"></span><br><span class="line">OpenBTS&gt; noise  </span><br><span class="line">noise RSSI <span class="keyword">is</span> <span class="number">-65</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line">MS RSSI target <span class="keyword">is</span> <span class="number">-50</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line"><span class="keyword">INFO</span>: the <span class="keyword">current</span> noise <span class="keyword">level</span> <span class="keyword">is</span> acceptable.</span><br><span class="line"></span><br><span class="line">OpenBTS&gt; power <span class="number">20</span></span><br><span class="line"><span class="keyword">current</span> downlink power <span class="number">-20</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line"></span><br><span class="line">OpenBTS&gt; noise   </span><br><span class="line">noise RSSI <span class="keyword">is</span> <span class="number">-72</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line">MS RSSI target <span class="keyword">is</span> <span class="number">-50</span> dB wrt <span class="keyword">full</span> scale</span><br><span class="line"><span class="keyword">INFO</span>: the <span class="keyword">current</span> noise <span class="keyword">level</span> <span class="keyword">is</span> acceptable.</span><br></pre></td></tr></table></figure>
<h3 id="0x153-提高手机的功率"><a href="#0x153-提高手机的功率" class="headerlink" title="0x153 提高手机的功率"></a>0x153 提高手机的功率</h3><p>手机可以通过调整<code>GSM.Radio.RSSI</code>和<code>GSM.Radio.SNR</code>的键值来加大功率。这些键值默认大小可以满足绝大多数情况下的使用。但如果遇到信号波动比较大的情况（比如在地下室墙角附近转悠），就需要增大这些键值来提供更宽泛的信号强度适应。提升手机功率能够提高上行链路质量，当然也会更加耗电，缩短手机续航时间，有得必有失。</p>
<p>如果调了这些以后，底噪还是太大，回到网络设置那里修改<code>ARFCN</code>，改到一个底噪更小的频率。</p>
<h2 id="0x160-第一次连接"><a href="#0x160-第一次连接" class="headerlink" title="0x160 第一次连接"></a>0x160 第一次连接</h2><p>在验证了上行和下行链路以后，为了确保所有的设置能够生效，需要重启<code>OpenBTS</code>：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">stop</span> openbts</span><br><span class="line"><span class="literal">start</span> openbts</span><br></pre></td></tr></table></figure>
<p>在手机接入网络之前还需要做的步骤是找到手机的特性参数，用来做网络准入。</p>
<h3 id="0x161-寻找IMSI"><a href="#0x161-寻找IMSI" class="headerlink" title="0x161 寻找IMSI"></a>0x161 寻找IMSI</h3><p>所要找的最主要的特性参数是IMSI(国际移动用户识别码)，这是存储在SIM卡中的14-15位数字，类似网络中的手机用户名。但手机通常不会泄露自己的SIM卡中的IMSI，有个别特殊手机在设置菜单可以看到，有个别特殊手机要在工程模式才能看到，总之要得到SIM卡的IMSI挺麻烦的。不过，还有其他方法。OpenBTS需要IMSI和它交互，而且你可以控制网络准入条件，那就可以强制手机进行网络交互的测试，然后在网络上执行<code>LUR</code>更新请求，类似注册。这和从运营商列表中选择网络一样简单。</p>
<p>在进行<code>LUR</code>注册之前，需要启动<code>SIPAuthServe</code>守护进程来处理这些请求：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">start</span> sipauthserve</span><br><span class="line">sipauthserve <span class="built_in">start</span>/running, <span class="built_in">process</span> <span class="number">3211</span></span><br></pre></td></tr></table></figure>
<p>现在在用手机搜索下运营商，然后再列表中选择测试网络，过一会儿后会提示注册网络失败。</p>
<p>实际上，如果注册网络成功，会收到一条提示短信，短信内容包括IMSI还有分配的号码(前提是有添加过号码)。所以只要没收到短信，就知道没有注册进入网络。</p>
<p><strong><font color=red>注意: 如果手机离基站太近是无法接入网络的，在log中会提示：</font></strong></p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Transceiver</span><span class="selector-class">.cpp</span><span class="selector-pseudo">:414</span><span class="selector-pseudo">:pullRadioVector</span>: <span class="selector-tag">Clipping</span> <span class="selector-tag">detected</span> <span class="selector-tag">on</span> <span class="selector-tag">RACH</span> <span class="selector-tag">input</span></span><br></pre></td></tr></table></figure>

<p>OpenBTS会记住这些<code>LUR</code>交互，用来进行IMSI/TMSI(临时识别码 )的变换。将IMSI变换为TMSI是为了保护用户的隐私，防止IMSI被窃取。这个变换功能的选项默认是关闭的(需要将<code>Control.LUR.SendTMSIs</code>选项打开)。之后，可以用<code>tmsis</code>命令查看这些信息。现在可以看到最近一段时间手机进行的<code>LUR</code>交互：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.SendTMSIs 1</span><br><span class="line">Control.LUR.SendTMSIs changed <span class="keyword">from</span> <span class="string">"0"</span> <span class="keyword">to</span> <span class="string">"1"</span></span><br></pre></td></tr></table></figure>

<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; tmsis</span><br><span class="line">IMSI            TMSI    IMEI            AUTH CREATED ACCESSED TMSI_ASSIGNED</span><br><span class="line"><span class="number">460022016844078</span> <span class="number">0x67803</span> <span class="number">013601000165670</span> <span class="number">0</span>    <span class="number">49</span>s     <span class="number">49</span>s      <span class="number">0</span>            </span><br><span class="line"><span class="number">460019839814046</span> <span class="number">0x21e60</span> <span class="number">352584061969410</span> <span class="number">0</span>    <span class="number">198</span>s    <span class="number">198</span>s     <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>这些条目按时间排序，越近的交互信息越靠上。所有的交互信息中<code>AUTH</code>都是<code>0</code>，因为手机不是已知用户导致<code>LUR</code>交互失败。如果有手机成功接入到网络，那么对应的<code>LUR</code>交互信息中的<code>AUTH</code>就是<code>1</code>了。</p>
<h3 id="0x162-寻找IMEI"><a href="#0x162-寻找IMEI" class="headerlink" title="0x162 寻找IMEI"></a>0x162 寻找IMEI</h3><p>在一个数据量较大的环境下，很难确定手机对应列表中的哪个条目。要匹配IMSI到一个特定的硬件，可以使用IMEI，这是手机的硬件唯一标识，类似网卡的mac地址。</p>
<p>手机的IMSI一般印刷在手机后面电池下面的外壳上或者其他很靠近SIM卡的位置，现在有些手机也会印刷在包装盒上(所谓的三码合一、四码和一都包含IMEI码)，在手机的设置或者工程模式一般也都看得到，也可以在拨号键盘输入<code>*#06#</code>获得。</p>
<p>IMEI值通常只在生产环境用来做报告和检测被盗，可以用来很方便的确认哪张SIM卡在这个手机中。不过，你手机的IMEI最后一位数字可能和OpenBTS上看到的不同，这是一个校验位，在OpenBTS中是<code>0</code>。</p>
<h3 id="0x163-添加用户"><a href="#0x163-添加用户" class="headerlink" title="0x163 添加用户"></a>0x163 添加用户</h3><p>你现在应该有了创建一个测试网络的新用户所需的所有必要信息。</p>
<p>还需要两个字段，这个可以自由选择：<code>Name</code>和<code>MSISDN</code>(移动台ISDN号码)，<code>Name</code>字段仅仅是这个用户的名称，用来关联手机或者用户的，<code>MSISDN</code>字段的含义和用户的手机号码差不多。以为你并没有连接到公共电话网络，所以可以设置成任何号码。</p>
<p>添加用户用的脚本是<code>nmcli.py</code>。这是<code>NodeManager APIs</code>的一个很简单的客户端，可以用它通过JSON格式的命令来更改配置参数、添加用户以及状态监控等等。</p>
<p><code>nmcli.py</code> 就在源码编译后的目录，进入目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> dev/NodeManager</span><br></pre></td></tr></table></figure>
<p>使用<code>nmcli.py</code>有两种方式可以添加用户：</p>
<p>第一种方法使用缓存的认证信息。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py sipauthserve subscribers <span class="keyword">create</span> <span class="type">name</span> imsi msisdn</span><br></pre></td></tr></table></figure>
<p>第二种方法使用完整的认证信息。</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py sipauthserve subscribers <span class="keyword">create</span> <span class="type">name</span> imsi msisdn ki</span><br></pre></td></tr></table></figure>
<p>如果IMSI是<code>用户名</code>，那么<code>密码</code>就是手机的<code>Ki码</code>。如果没有得到<code>Ki码</code>，就只能用第一种方法添加用户。如果你有在烧写SIM卡，那肯定知道自己的<code>Ki码</code>，那就可以用第二种方法添加用户。比如说：</p>
<figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py sipauthserve <span class="keyword">subscribers </span>create <span class="string">"iPhone4s"</span> IMSI460022016844078 <span class="number">6055551001</span></span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">raw request: &#123;<span class="string">"command"</span>:<span class="string">"subscribers"</span>,<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"fields"</span>:&#123;<span class="string">"name"</span>:<span class="string">"iPhone4s"</span>,<span class="string">"imsi"</span>:<span class="string">"IMSI460022016844078"</span>,<span class="string">"msisdn"</span>:<span class="string">"6055551001"</span>,<span class="string">"ki"</span>:<span class="string">""</span>&#125;&#125;</span><br><span class="line">raw response: &#123;</span><br><span class="line">        <span class="string">"code"</span> : 200,</span><br><span class="line">        <span class="string">"data"</span> : <span class="string">"both ok"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再加入另一个：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py sipauthserve subscribers create <span class="string">"Nexus"</span> IMSI460019839814046 6055551002</span><br><span class="line">raw request: &#123;<span class="string">"command"</span>:<span class="string">"subscribers"</span>,<span class="string">"action"</span>:<span class="string">"create"</span>,<span class="string">"fields"</span>:&#123;<span class="string">"name"</span>:<span class="string">"Nexus"</span>,<span class="string">"imsi"</span>:<span class="string">"IMSI460019839814046"</span>,<span class="string">"msisdn"</span>:<span class="string">"6055551002"</span>,<span class="string">"ki"</span>:<span class="string">""</span>&#125;&#125;</span><br><span class="line">raw response: &#123;</span><br><span class="line">        <span class="string">"code"</span> : 200,</span><br><span class="line">        <span class="string">"data"</span> : <span class="string">"both ok"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检查下添加的用户：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py  sipauthserve subscribers read                                           </span><br><span class="line">raw request: &#123;<span class="string">"command"</span>:<span class="string">"subscribers"</span>,<span class="string">"action"</span>:<span class="string">"read"</span>,<span class="string">"key"</span>:<span class="string">""</span>,<span class="string">"value"</span>:<span class="string">""</span>&#125;</span><br><span class="line">raw response: &#123;</span><br><span class="line">        <span class="string">"code"</span> : 200,</span><br><span class="line">        <span class="string">"data"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"imsi"</span> : <span class="string">"IMSI460022016844078"</span>,</span><br><span class="line">                        <span class="string">"msisdn"</span> : <span class="string">"6055551001"</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"iPhone4s"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"imsi"</span> : <span class="string">"IMSI460019839814046"</span>,</span><br><span class="line">                        <span class="string">"msisdn"</span> : <span class="string">"6055551002"</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"Nexus"</span></span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果有输入错误的，删除对应的<code>IMSI</code></p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.<span class="keyword">py</span> sipauthserve subscribers <span class="keyword">delete</span> imsi IMSI460019839814046</span><br></pre></td></tr></table></figure>

<p>现在就可以将这两台手机加入到测试网络了，iPhone4s手机号为<code>6055551001</code>，Nexus手机号为<code>6055551002</code></p>
<h3 id="0x164-接入网络"><a href="#0x164-接入网络" class="headerlink" title="0x164 接入网络"></a>0x164 接入网络</h3><p>在手机中选择运营商再次加入网络，<code>LUR</code>交互应该会成功。这时候通过<code>tmsis</code>命令可以看到<code>AUTH</code>的值为<code>1</code>了。对于<code>IMSI</code>列表如下：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; tmsis</span><br><span class="line">IMSI            TMSI    IMEI            AUTH CREATED ACCESSED TMSI_ASSIGNED </span><br><span class="line"><span class="number">460019839814046</span> <span class="number">0x21e60</span> <span class="number">352584061969410</span> <span class="number">1</span>    <span class="number">90</span>m     <span class="number">25</span>s      <span class="number">1</span>             </span><br><span class="line"><span class="number">460022016844078</span> <span class="number">0x67803</span> <span class="number">013601000165670</span> <span class="number">1</span>    <span class="number">88</span>m     <span class="number">79</span>s      <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>恭喜，到现在为止，手机已经成功注册到了私人移动网络，以后可以随意注册任何手机到这个网络中了。</p>
<h2 id="0x170-短信测试"><a href="#0x170-短信测试" class="headerlink" title="0x170 短信测试"></a>0x170 短信测试</h2><p>手机注册进网络以后，就可以进行一些更有意思的测试，首先是网络中的短信的简单测试。</p>
<p>负责接收、路由转发和调度的应用服务是<code>SMQueue</code>，所以需求先启动这个服务：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">start</span> smqueue</span><br><span class="line">smqueue <span class="built_in">start</span>/running, <span class="built_in">process</span> <span class="number">3531</span></span><br></pre></td></tr></table></figure>

<h3 id="0x171-短信编写-411"><a href="#0x171-短信编写-411" class="headerlink" title="0x171 短信编写(411)"></a>0x171 短信编写(411)</h3><p>在手机中，写一条短信发给<code>411</code>。这是<code>SMQueue</code>中的一个<code>简码</code>处理流程，只管回显，不管其他接收、网络及用户信息等整个流程所用任何信息。发送给<code>411</code>的短信的可以是任意内容，可以是任意的文字或者数字或者字母。这个可以用来帮你确认哪条消息在回应时候出错。</p>
<p>编写一条发往<code>411</code>短信，点击发送，几秒钟之后，应该会出现应答，举例如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">“1 queued, cell 0.1, IMSI460022016844078, phonenum 6055551001, at Sep 8 02:30:59,</span><br><span class="line">Ping pong<span class="string">"</span></span><br><span class="line"><span class="string">包含的内容如下：</span></span><br><span class="line"><span class="string">• 一个短信队列等待发送.</span></span><br><span class="line"><span class="string">• 基站负载 0.1.</span></span><br><span class="line"><span class="string">• 短信收件方：IMSI 460022016844078, MSISDN 6055551001.</span></span><br><span class="line"><span class="string">• 短信发送时间：September 8 at 02:30:59.</span></span><br><span class="line"><span class="string">• 短信内容为：“Ping pong.”</span></span><br></pre></td></tr></table></figure>

<h3 id="0x172-直接发送短信"><a href="#0x172-直接发送短信" class="headerlink" title="0x172 直接发送短信"></a>0x172 直接发送短信</h3><p>在OpenBTS上也可以用<code>sendsms</code>命令直接发送短信进行测试。在<code>OpenBTSCLI</code>中，可以看下这条命令的帮助信息：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; help sendsms</span><br><span class="line">sendsms IMSI src# message<span class="built_in">..</span>. -- send direct<span class="built_in"> SMS </span><span class="keyword">to</span> IMSI on this BTS, addressed <span class="keyword">from</span> source number src#.</span><br></pre></td></tr></table></figure>

<p>消息发送到指定<code>IMSI</code>，发件人号码<code>src#</code>，短信内容<code>message</code>。比如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; sendsms 460019839814046 12345 direct<span class="built_in"> SMS </span>test</span><br><span class="line">message submitted <span class="keyword">for</span> delivery</span><br><span class="line"> </span><br><span class="line">OpenBTS&gt; sendsms 460022016844078 67890 direct<span class="built_in"> SMS </span>test                   </span><br><span class="line">message submitted <span class="keyword">for</span> delivery</span><br></pre></td></tr></table></figure>
<p>过几秒后，手机会收到短信，Nexus手机收到发自<code>12345</code>的短信，内容为<code>direct SMS test</code>，iPhone4s 收到发自<code>67890</code>的短信，内容也是<code>direct SMS test</code>。</p>
<p>这种方式创建的短信不通过<code>SMQueue</code>服务的路由，而是直接通过GSM的空中接口发送给手机，因此，这种方式发的短信不会被重发，如果手机处于离线状态或者无法接入网络，这些短信就会被丢弃。所以，在通信质量不可靠的网络环境下，<code>SMQueue</code>服务会对短信进行重发。</p>
<h3 id="0x173-双方互发短信"><a href="#0x173-双方互发短信" class="headerlink" title="0x173 双方互发短信"></a>0x173 双方互发短信</h3><p>如果在网络中加入了多台手机，可以给相互发几条短信试试，号码就是之前注册进网络时候设置的号码。如果号码错误，会收到收到短信提示说无法发送短信到xxx(给<code>101</code>发送8-10位数字，基站就会回复这台手机所注册的手机号)。</p>
<h2 id="0x180-语音通话测试"><a href="#0x180-语音通话测试" class="headerlink" title="0x180 语音通话测试"></a>0x180 语音通话测试</h2><p>还有测试语音通话的服务，和短信类似，OpenBTS不直接处理语言通话，需要运行额外的服务，启用<code>asterisk</code>服务：</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">start</span> asterisk</span><br><span class="line">asterisk <span class="built_in">start</span>/running, <span class="built_in">process</span> <span class="number">3625</span></span><br></pre></td></tr></table></figure>
<p>和测试短信一样，用你的手机进行语音通话方面的验证。这是通过配置range-asterisk-config包，进行几项测试的。测试范围是内部号码，外网的电话无法接入。</p>
<h3 id="0x181-呼叫测试-2602"><a href="#0x181-呼叫测试-2602" class="headerlink" title="0x181 呼叫测试(2602)"></a>0x181 呼叫测试(2602)</h3><p>第一个呼叫测试听到的只是一段连续的声音，尽管听起来不是很爽，但至少可以确认一些东西：</p>
<ol>
<li>asterisk服务正常工作</li>
<li>语音呼叫路由正常工作</li>
<li>语音的下行链路正常</li>
</ol>
<p>用手机拨打<code>2062</code>，听听语音，可以感觉到声音音调的改变，这些音调的变化是因为下行语音链路中丢了一些数据。在这里，语音测试的最主要应用是测试下行链路的质量。一个下行链路在生产环境有3%丢包率，那么在正常使用时候会有5%-7%的丢包率。</p>
<h3 id="0x182-回音测试-2600"><a href="#0x182-回音测试-2600" class="headerlink" title="0x182 回音测试(2600)"></a>0x182 回音测试(2600)</h3><p>第二个呼叫测试是一个”回音测试”，也就是你说什么，就能听到什么，基本上能把所有接收到的语音通话即时的回放给发送者。回声测试除了可以用来测试语音通话，还能测试网络中延时情况和上行链路质量。</p>
<p>用手机拨打<code>2600</code>，然后对着手机麦克风说话，就可以听到自己说的话，有一点延迟是正常的，但延迟如果太长就会感觉在用对讲机。人类的大脑能够处理大约200ms的延迟，如果超过这个时间，两边都会感觉不舒服，从而挂断电话。</p>
<h3 id="0x183-双方通话"><a href="#0x183-双方通话" class="headerlink" title="0x183 双方通话"></a>0x183 双方通话</h3><p>如果网络中有好几台手机，可以互相拨打电话，接到电话后回拨一个。</p>
<h2 id="0x190-链路质量测试"><a href="#0x190-链路质量测试" class="headerlink" title="0x190 链路质量测试"></a>0x190 链路质量测试</h2><p>在<code>OpenBTS CLI</code>中有一个很方便的命令工具<code>chans</code>，用这个命令可以客观的量化用户所感知到的基础链路质量。<br>比如说，在拨打<code>2602</code>测试语音通话，<code>10秒</code>后执行<code>chans</code>命令(注意时间栏)，然后将两个手机一个拿远一米一个拿近一米，再执行<code>chans</code>命令，就能很明显的看到区别：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; chans</span><br><span class="line">CN TN chan  transaction Signal SNR  FER   TA  TXPWR RXLEV_DL BER_DL Time IMSI           </span><br><span class="line">      type  id          dB          pct   sym dBm   dBm      pct                        </span><br><span class="line"><span class="number">0</span>  <span class="number">1</span>  TCH/F T165        <span class="number">19</span>     <span class="number">47.3</span> <span class="number">1.19</span>  <span class="number">0.0</span> <span class="number">11</span>    <span class="number">-88</span>      <span class="number">4.53</span>   <span class="number">0</span>:<span class="number">24</span> <span class="number">460022016844078</span></span><br><span class="line"><span class="number">0</span>  <span class="number">2</span>  TCH/F T166        <span class="number">22</span>     <span class="number">24.5</span> <span class="number">0.95</span>  <span class="number">0.2</span> <span class="number">7</span>     <span class="number">-80</span>      <span class="number">0.00</span>   <span class="number">0</span>:<span class="number">19</span> <span class="number">460019839814046</span> </span><br><span class="line"></span><br><span class="line">OpenBTS&gt; chans</span><br><span class="line">CN TN chan  transaction Signal SNR  FER   TA   TXPWR RXLEV_DL BER_DL Time IMSI           </span><br><span class="line">      type  id          dB          pct   sym  dBm   dBm      pct                        </span><br><span class="line"><span class="number">0</span>  <span class="number">1</span>  TCH/F T165        <span class="number">25</span>     <span class="number">57.6</span> <span class="number">0.15</span>  <span class="number">-0.1</span> <span class="number">9</span>     <span class="number">-78</span>      <span class="number">0.00</span>   <span class="number">0</span>:<span class="number">42</span> <span class="number">460022016844078</span></span><br><span class="line"><span class="number">0</span>  <span class="number">2</span>  TCH/F T166        <span class="number">18</span>     <span class="number">52.7</span> <span class="number">0.44</span>  <span class="number">0.3</span>  <span class="number">15</span>    <span class="number">-96</span>      <span class="number">0.28</span>   <span class="number">0</span>:<span class="number">37</span> <span class="number">460019839814046</span></span><br></pre></td></tr></table></figure>


<p>在很多地方，这些数据很有用，不过在这里我们主要关注<code>SNR</code>(信噪比)，<code>TXPWR</code>(发送功率)，<code>RXLEV_DL</code>(接收灵敏度)。这后面两个参数，代表一个活动的信道，<code>SNR</code>是基站上行链路的信噪比测量值，这个数值越大越好。当手机被拿远后，这个数值反而提高了，这是为何？原因在于<code>TXPWR</code>的值，这个数值是手机反馈的上行链路功耗，第二次读的时候，一个手机的这个参数从<code>7</code>变成<code>15</code>，这说明手机在上行链路启用了更大功耗，这就可以解释为何基站<code>SNR</code>更高。</p>
<p>这个私人独立网络会告知不同的要连接基站所需手机的功耗，而手机为何基站附近的手机的信号强度都差不多，因为这样解调更容易，毕竟是同一个基站，所有手机下行链路的信号强度都差不多。</p>
<p>另外，<code>RXLEV_DL</code>所在那一列中的数值，都是手机下行链路信号强度。第二次读的时候，手机挪远以后，这个数值从<code>-80dBm</code>降到<code>-96dBm</code>，因为手机挪远以后距离基站更远，收到的下行链路数据的信号更弱。</p>
<p>使用<code>help</code>可以看到这个命令的参数列表：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; help chans</span><br><span class="line">chans [-a -l -tab] -- report PHY status <span class="keyword">for</span> active channels</span><br><span class="line">  -a -- report <span class="keyword">for</span> all channels</span><br><span class="line">  -l -- <span class="keyword">for</span> longer listing</span><br><span class="line">  -tab -- <span class="keyword">for</span> tab-separated output format</span><br><span class="line">  CN - Channel Number;</span><br><span class="line">  TN - Timeslot Number;</span><br><span class="line">  chan<span class="built_in"> type </span>- the dedicated channel type, <span class="keyword">or</span> GPRS <span class="keyword">if</span> reserved <span class="keyword">for</span> Packet Services;</span><br><span class="line">  transaction id - One <span class="keyword">or</span> more Layer 3 transactions running on this channel;</span><br><span class="line">  LAPDm state - The current acknowledged message state, <span class="keyword">if</span> any, otherwise <span class="string">'active'</span> <span class="keyword">or</span> <span class="string">'inactive'</span>;</span><br><span class="line">  recyc - <span class="literal">true</span> <span class="keyword">if</span> channel is recyclable, ie, can be reused now;</span><br><span class="line">  Signal - Uplink signal strength <span class="keyword">if</span> MS were at full transmit power, relative <span class="keyword">to</span> configured GSM.Radio.RSSITarget.  0 <span class="keyword">or</span> less is bad;</span><br><span class="line">  RSSP - Uplink RSSI possible <span class="keyword">if</span> MS were at full transmit power;</span><br><span class="line">  RSSI - Uplink signal level dB measured by BTS, should be above<span class="built_in"> config </span>parameter GSM.Radio.RSSITarget;</span><br><span class="line">  SNR - Uplink Signal <span class="keyword">to</span> Noise Ratio measured by BTS, higher is better, less than 10 is probably unusable;</span><br><span class="line">  FER - Uplink voice frame loss rate as a percentage measured by BTS;</span><br><span class="line">  BER - Uplink Bit <span class="builtin-name">Error</span> Rate before decoding measured by BTS, as a percentage;</span><br><span class="line">  TA - Timing advance <span class="keyword">in</span> symbol periods measured by the BTS;</span><br><span class="line">  TXPWR - Uplink transmit power dB reported by MS;</span><br><span class="line">  TA_DL - Timing advance <span class="keyword">in</span> symbol periods reported by MS;</span><br><span class="line">  RXLEV_DL - Downlink signal level dB reported by MS;</span><br><span class="line">  BER_DL - Downlink Bit <span class="builtin-name">Error</span> rate percentage reported by MS;</span><br><span class="line">  IMSI - International Mobile Subscriber Id of the MS on this channel, reported only <span class="keyword">if</span> known; may also be:</span><br><span class="line">      <span class="string">'no-MMChannel'</span> <span class="keyword">to</span> indicate <span class="literal">no</span> Mobility Management channel, which happens when</span><br><span class="line">                     the Layer 2 RR channel is open but has <span class="keyword">not</span> yet sent any Layer 3 messages, <span class="keyword">or</span></span><br><span class="line">      <span class="string">'no-MMUser'</span> <span class="keyword">to</span> indicate that Layer 3 is connected (an MMChannel exists) but the IMSI is <span class="keyword">not</span> yet known.</span><br><span class="line">  Time - Channel<span class="built_in"> connection </span>duration <span class="keyword">in</span> seconds;</span><br><span class="line">  Timers - Internal channel timers;</span><br><span class="line">  Frames - number of bad, stolen, <span class="keyword">and</span> total frames sent, only <span class="keyword">for</span> traffic channels;</span><br><span class="line"> <span class="built_in"> Neighbor </span>ARFCN <span class="keyword">and</span> dBm - The best neighbor<span class="string">'s channel and downlink RSSI reported by the MS;</span></span><br><span class="line"><span class="string">  Layer1 - state of layer1 for host (TCH or DCCH) and SACCH sub-channels.</span></span><br></pre></td></tr></table></figure>

<h2 id="0x1A0-继续配置系统"><a href="#0x1A0-继续配置系统" class="headerlink" title="0x1A0 继续配置系统"></a>0x1A0 继续配置系统</h2><p>在本章节中，你已经熟悉了几个<code>OpenBTS</code>命令，其中绝大多数最重要的就是配置。在配置之前，有些参数需要做一下调整。</p>
<h3 id="0x1A1-config"><a href="#0x1A1-config" class="headerlink" title="0x1A1 config"></a>0x1A1 config</h3><p>你可以用<code>config</code>命令查看所有可以配置的选项以及当前对应的参数。也可以查看某一个配置项及对应的参数，只要加上配置项完整的名称。比如：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>SIP.Proxy.SMS</span><br><span class="line">SIP.Proxy.SMS 127.0.0.1:5063     [default]</span><br><span class="line"> - description:      The hostname <span class="keyword">or</span><span class="built_in"> IP address </span><span class="keyword">and</span><span class="built_in"> port </span>of the<span class="built_in"> proxy </span><span class="keyword">to</span> be used <span class="keyword">for</span> text messaging.  This is smqueue, <span class="keyword">for</span> example.</span><br><span class="line"> - type:             hostname <span class="keyword">or</span><span class="built_in"> IP address </span><span class="keyword">and</span> port</span><br><span class="line"> -<span class="built_in"> default </span>value:    127.0.0.1:5063</span><br><span class="line">- visibility level:<span class="built_in"> customer </span>warn - a <span class="builtin-name">warning</span> will be presented <span class="keyword">and</span> confirmation required before changing this sensitive setting</span><br><span class="line"> - static:           0</span><br><span class="line"> - scope:            value must be the same across all nodes</span><br></pre></td></tr></table></figure>

<h3 id="0x1A2-devconfig"><a href="#0x1A2-devconfig" class="headerlink" title="0x1A2 devconfig"></a>0x1A2 devconfig</h3><p><code>devconfig</code>和<code>config</code>类似，但这个命令可以操控更多选项，每个键值都可以看到不同用户(普通用户、开发人员、出厂设置)对应不同的参值。使用<code>devconfig</code>命令可以访问很多很敏感的键值，比如协议定时器：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">GSM</span><span class="selector-class">.Timer</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.Handover</span><span class="selector-class">.Holdoff</span> 10     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.T3109</span> 30000     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.T3212</span> 0     <span class="selector-attr">[default]</span></span><br><span class="line"> </span><br><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">devconfig</span> <span class="selector-tag">GSM</span><span class="selector-class">.Timer</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.Handover</span><span class="selector-class">.Holdoff</span> 10     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.T3103</span> 12000     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.T3105</span> 50     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.T3109</span> 30000     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.T3113</span> 10000     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.T3212</span> 0     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<h3 id="0x1A3-rawconfig"><a href="#0x1A3-rawconfig" class="headerlink" title="0x1A3 rawconfig"></a>0x1A3 rawconfig</h3><p><code>rawconfig</code>命令调整的参数范围比<code>devconfig</code>要大一些，并且会移除所有的输入验证。如果有想将某个配置项的参数调到正常范围以外，就需要用<code>rawconfig</code>命令。<br><code>rawconfig</code>命令的另一个用途就是可以在数据库中定义一个全新的自定义的键值/参数，这在创建一个新的功能时候很有用。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; rawconfig My.New.Setting zebra</span><br><span class="line">defined new<span class="built_in"> config </span>My.New.Setting as <span class="string">"zebra"</span></span><br></pre></td></tr></table></figure>

<h3 id="0x1A4-unconfig"><a href="#0x1A4-unconfig" class="headerlink" title="0x1A4 unconfig"></a>0x1A4 unconfig</h3><p>有一些可控可调的参数选项是可以禁用的，用<code>unconfig</code>命令就可以将某些参数选项禁用。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.FailedRegistration.Message</span><br><span class="line">Control.LUR.FailedRegistration.Message Your handset is <span class="keyword">not</span> provisioned <span class="keyword">for</span> this network.      [default]</span><br><span class="line"> - description:      Send this text message, followed by the IMSI, <span class="keyword">to</span> unprovisioned handsets that are denied registration.</span><br><span class="line"> - type:             string (optional)</span><br><span class="line"> -<span class="built_in"> default </span>value:    Your handset is <span class="keyword">not</span> provisioned <span class="keyword">for</span> this network.</span><br><span class="line">- visibility level:<span class="built_in"> customer </span>- can be freely changed by the<span class="built_in"> customer </span>without any detriment <span class="keyword">to</span> their system</span><br><span class="line"> - static:           0</span><br><span class="line">-<span class="built_in"> raw </span>valid values: ^[ -~]+$</span><br></pre></td></tr></table></figure>

<p>这时候用<code>unconfig</code>命令就可以将这个选项禁用，并反馈禁用成功。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">unconfig</span> <span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.FailedRegistration</span><span class="selector-class">.Message</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.FailedRegistration</span><span class="selector-class">.Message</span> <span class="selector-tag">disabled</span></span><br></pre></td></tr></table></figure>

<h3 id="0x1A5-rmconfig"><a href="#0x1A5-rmconfig" class="headerlink" title="0x1A5 rmconfig"></a>0x1A5 rmconfig</h3><p>如果想把某个键值恢复到默认值，用<code>rmconfig</code>命令：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; rmconfig SIP.Proxy.SMS</span><br><span class="line">SIP.Proxy.SMS <span class="builtin-name">set</span> back <span class="keyword">to</span> its<span class="built_in"> default </span>value</span><br></pre></td></tr></table></figure>

<p>这个命令也可以用来删除用<code>rawconfg</code>自定义的键值/参数：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; rmconfig My.<span class="built_in">New</span>.Setting</span><br><span class="line">My.<span class="built_in">New</span>.Setting removed <span class="keyword">from</span> the <span class="keyword">configuration</span> <span class="keyword">table</span></span><br></pre></td></tr></table></figure>

<h2 id="0x1B0-个性化网络定制"><a href="#0x1B0-个性化网络定制" class="headerlink" title="0x1B0 个性化网络定制"></a>0x1B0 个性化网络定制</h2><p>你的网络能正常运行，并且知道如何控制它，这是一个很好的开端。这是你自己的私人网络，所以应该定制一个符合你口味的网络。这里将要讲述的就是如何个性化定制私人网络。<br>###短名称<br>短名称就是手机搜索运营商时候看到的运营商名称，这是人们搜索运营商网络时候第一个注意到的信息，所以需要将OpenBTS的默认名<code>Range</code>改一下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Identity.ShortName</span><br><span class="line">GSM.Identity.ShortName Range     [default]</span><br><span class="line"> - description:     <span class="built_in"> Network </span>short name, displayed on some phones.  Optional but must be defined <span class="keyword">if</span> you also want the<span class="built_in"> network </span><span class="keyword">to</span> send time-of-day.</span><br><span class="line"> - type:             string</span><br><span class="line"> -<span class="built_in"> default </span>value:    Range</span><br><span class="line">- visibility level:<span class="built_in"> customer </span>site - these values are different <span class="keyword">for</span> each BTS <span class="keyword">and</span> should <span class="keyword">not</span> be left default</span><br><span class="line"> - static:           0</span><br><span class="line"> - valid val regex:  ^[0-9a-zA-Z]+$</span><br><span class="line"> - scope:            value must be the same across all nodes</span><br><span class="line"></span><br><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Identity.ShortName White</span><br><span class="line">GSM.Identity.ShortName changed <span class="keyword">from</span> <span class="string">"Range"</span> <span class="keyword">to</span> <span class="string">"White"</span></span><br></pre></td></tr></table></figure>
<p>注意，只能包含数字和字母，不能包含空格和特殊符号。</p>
<h3 id="0x1B1-注册短信提示"><a href="#0x1B1-注册短信提示" class="headerlink" title="0x1B1 注册短信提示"></a>0x1B1 注册短信提示</h3><p>在之前手机注册入网的时候，可以注册失败，可以让手机收到<code>registration failed</code>短信。其实这样的反馈短信有好几种，分别用来针对不同的事件。<br>可以看下配置列表，然后搜索<code>Registration.Message</code>配置项，里面有对应的名称：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span>  <span class="selector-tag">Registration</span><span class="selector-class">.Message</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.FailedRegistration</span><span class="selector-class">.Message</span> <span class="selector-tag">Your</span> <span class="selector-tag">handset</span> <span class="selector-tag">is</span> <span class="selector-tag">not</span> <span class="selector-tag">provisioned</span> <span class="selector-tag">for</span> <span class="selector-tag">this</span> <span class="selector-tag">network</span>.      <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.NormalRegistration</span><span class="selector-class">.Message</span> (<span class="selector-tag">disabled</span>)     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span><span class="selector-class">.Message</span> <span class="selector-tag">Welcome</span> <span class="selector-tag">to</span> <span class="selector-tag">the</span> <span class="selector-tag">test</span> <span class="selector-tag">network</span>.  <span class="selector-tag">Your</span> <span class="selector-tag">IMSI</span> <span class="selector-tag">is</span>      <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>
<p>注册失败的短信提示挺有用，但有点土，可以用<code>config</code>命令改个cool点的：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.FailedRegistration.Message Hello,World!</span><br><span class="line">Control.LUR.FailedRegistration.Message changed <span class="keyword">from</span> <span class="string">"Your handset is not provisioned for this network. "</span> <span class="keyword">to</span> <span class="string">"Hello,World!"</span></span><br></pre></td></tr></table></figure>
<p>或者还可以用<code>unconfig</code>命令来禁用注册失败的短信提示。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">unconfig</span> <span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.FailedRegistration</span><span class="selector-class">.Message</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.FailedRegistration</span><span class="selector-class">.Message</span> <span class="selector-tag">disabled</span></span><br></pre></td></tr></table></figure>
<p>另外还有一种短信，<code>Control.LUR.NormalRegistration.Message</code>选项，默认这个选项是关的，作用是每次手机入网时候都给它发一条提示短信。<br>如果将基站部署在一个生产环境，对于实验室很有用，特别是在调多个基站的时候，这个短信可以作为更新注册或者切换网络的通知。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.NormalRegistration.Message Welcome <span class="keyword">to</span> WhiteBTS</span><br><span class="line">Control.LUR.NormalRegistration.Message changed <span class="keyword">from</span> <span class="string">"enable"</span> <span class="keyword">to</span> <span class="string">"Welcome to WhiteBTS"</span></span><br></pre></td></tr></table></figure>

<p>为了测试它，将手机打开电源并循环开关飞行模式，每当手机重新获得基站信号并注册入网，就会收到一条入网提示短信。</p>
<hr>
<h1 id="故障排除和性能优化"><a href="#故障排除和性能优化" class="headerlink" title="故障排除和性能优化"></a>故障排除和性能优化</h1><hr>
<p>当你的网络准备付诸实用的时候，你需要一些额外的技术来帮助调试它们的问题。除了一些错误配置导致的问题，很多问题都不明显。依据部署状况和网络模式，存在的问题可能是性能达不到预期，这种情况下就需要对网络进行调优。所以故障解决和调优，总让人不爽。</p>
<h2 id="0x210-stats状态命令"><a href="#0x210-stats状态命令" class="headerlink" title="0x210 stats状态命令"></a>0x210 stats状态命令</h2><p>有一个可以简单快捷的观察OpenBTS运行状态的命令<code>stats</code>。假如有几十个事件需要跟踪，先看整个列表，执行不带参数的<code>stats</code>命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">OpenBTS&gt;</span><span class="bash"> stats</span></span><br></pre></td></tr></table></figure>
<p>每一个事件类型的键值名称和键值/参数以及相对应的时间，都被存储在一个小的<code>sqlite3</code>数据库里面，只保留最后一次统计的数据，之前的都被清掉了。清掉之前的数据库来统计你所需要的事件记录，用以下命令：</p>
<figure class="highlight gams"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; stats clear</span><br><span class="line">stats <span class="keyword">table</span> (gReporting) cleared</span><br></pre></td></tr></table></figure>
<p>现在，如果你从一台手机给另一台手机发条短信，然后搜索短信的记录，可以看到以下内容：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">stats</span> <span class="selector-tag">SMS</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span><span class="selector-class">.GSM</span><span class="selector-class">.MM</span><span class="selector-class">.CMServiceRequest</span><span class="selector-class">.MOSMS</span>: 1 <span class="selector-tag">events</span> <span class="selector-tag">over</span> 0 <span class="selector-tag">minutes</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span><span class="selector-class">.GSM</span><span class="selector-class">.SMS</span><span class="selector-class">.MOSMS</span><span class="selector-class">.Start</span>: 1 <span class="selector-tag">events</span> <span class="selector-tag">over</span> 0 <span class="selector-tag">minutes</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span><span class="selector-class">.GSM</span><span class="selector-class">.SMS</span><span class="selector-class">.MOSMS</span><span class="selector-class">.Complete</span>: 1 <span class="selector-tag">events</span> <span class="selector-tag">over</span> 0 <span class="selector-tag">minutes</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span><span class="selector-class">.GSM</span><span class="selector-class">.SMS</span><span class="selector-class">.MTSMS</span><span class="selector-class">.Start</span>: 1 <span class="selector-tag">events</span> <span class="selector-tag">over</span> 0 <span class="selector-tag">minutes</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span><span class="selector-class">.GSM</span><span class="selector-class">.SMS</span><span class="selector-class">.MTSMS</span><span class="selector-class">.Complete</span>: 1 <span class="selector-tag">events</span> <span class="selector-tag">over</span> 0 <span class="selector-tag">minutes</span></span><br></pre></td></tr></table></figure>
<p><code>OpenBTS.GSM.MM.CMServiceRequest.MOSMS</code>表明一个手机信号向移动基站发起<code>初始短信请求(MOSMS)</code>，<code>OpenBTS.GSM.SMS.MOSMS.Start</code>和<code>Complete</code>键值表明图个<code>MOSMS</code>请求的开始和完成，前三个键值都是从手机发送到基站，后两个键值表示从基站到目标手机的<code>结束短信请求(MTSMS)</code>的开始和完成。</p>
<h2 id="0x220-运行日志"><a href="#0x220-运行日志" class="headerlink" title="0x220 运行日志"></a>0x220 运行日志</h2><p>所有的日志都存储在<code>/var/log/OpenBTS.log</code>文件，如果想实时监控日志变化，用一下命令：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail <span class="params">-f</span> /<span class="built_in">var</span>/<span class="keyword">log</span>/OpenBTS.<span class="keyword">log</span></span><br></pre></td></tr></table></figure>
<p>如果只想监控某些关键字相关日志，可以跟上<code>grep</code>命令，比如只想查看包含<code>sipauthserve</code>关键字的日志，可以执行：</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tail -f /var/<span class="built_in">log</span>/OpenBTS.<span class="built_in">log</span> <span class="string">| grep sipauthserve</span></span><br></pre></td></tr></table></figure>

<p>如果只想查看现有日志文件中的历史记录，可以执行：</p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep sipauthserve /<span class="built_in">var</span>/<span class="keyword">log</span>/OpenBTS.<span class="keyword">log</span></span><br></pre></td></tr></table></figure>

<p>日志包含很多不同的条目信息。下面是OpenBTS产生日志的示例项：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Jan 28 16:20:30 (none) openbts: NOTICE 3025:3025 2015-01-28T16:20:30.9 GSMConfig.cpp:136:regenerateBeacon: regenerating<span class="built_in"> system </span>information messages, changemark 27</span><br><span class="line">这段日志包含以下内容：</span><br><span class="line">• 数据写入时间戳: <span class="string">"Jan 28 16:20:30"</span></span><br><span class="line">• 系统版本: <span class="string">"(none)"</span></span><br><span class="line">• 事件级别: <span class="string">"NOTICE"</span></span><br><span class="line">• 事件用户组: <span class="string">"3025:3025"</span></span><br><span class="line">• 数据创建时间戳: <span class="string">"2015-01-28T16:20:30.9"</span></span><br><span class="line">• 事件代码、行数及函数名: <span class="string">"GSMConfig.cpp:136:regenerateBeacon"</span></span><br><span class="line">• 事件文本: <span class="string">"regenerating system information messages, changemark 27"</span></span><br></pre></td></tr></table></figure>

<h3 id="0x221-日志级别"><a href="#0x221-日志级别" class="headerlink" title="0x221 日志级别"></a>0x221 日志级别</h3><p>默认情况下，日志等级只设置在<code>NOTICE</code>及在它之上等级，一般这些信息就足够调试一些典型的错误，比如掉线和高干扰率。在<code>OpenBTS</code>系统中一共有8个等级的日志报告：</p>
<p><code>EMERG</code><br>报告硬件故障或者服务故障引起的严重故障</p>
<p><code>ALERT</code><br>报告因为错误配置或者连接质量差引起的服务连接断开</p>
<p><code>CRIT</code><br>报告比如服务降级一类的异常事件</p>
<p><code>ERR</code><br>报告异常情况下可能会导致服务降级的软件内部错误</p>
<p><code>WARNING</code><br>报告异常情况下可能会导致正常服务降级的标识</p>
<p><code>NOTICE</code><br>报告异常情况，哪怕不会影响正常服务，但网络管理员可能比较感兴趣的信息</p>
<p><code>INFO</code><br>报告一般事件</p>
<p><code>DEBUG</code><br>会降低系统性能，只有开发人员才会使用</p>
<p>调整不同的日志等级，可以得到不同的系统信息输出。<br>比如<code>INFO</code>等级，会报告一般事件(包含NOTICE以及之上等级的信息)。这些正常时间的信息能够推断出可能出现错误的地方。要更改日志等级，执行以下命令：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Log.Level INFO</span><br><span class="line">Log.Level changed <span class="keyword">from</span> <span class="string">"NOTICE"</span> <span class="keyword">to</span> <span class="string">"INFO"</span></span><br></pre></td></tr></table></figure>

<p>一旦在本地日志中发现了一些可疑的行为，就能从日志字段中代码的那一部分获取更多的信息。比如前面例子中的事件，就是从<code>GSMConfig.cpp</code>中发出的，如果想要将这个代码文件开启<code>DEBUG</code>等级日志需要执行：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; rawconfig Log.Level.GSMConfig.cpp DEBUG</span><br><span class="line">defined new<span class="built_in"> config </span>Log.Level.GSMConfig.cpp as <span class="string">"DEBUG"</span></span><br></pre></td></tr></table></figure>

<p>需要用<code>rawconfig</code>命令来定义这个键值/参数，因为这不在标准配置中。所需如果要从配置数据库中删除这个键值/参数，需要用<code>rmconfig</code>命令：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; rmconfig <span class="module-access"><span class="module"><span class="identifier">Log</span>.</span><span class="module"><span class="identifier">Level</span>.</span><span class="module"><span class="identifier">GSMConfig</span>.</span></span>cpp  </span><br><span class="line"><span class="module-access"><span class="module"><span class="identifier">Log</span>.</span><span class="module"><span class="identifier">Level</span>.</span><span class="module"><span class="identifier">GSMConfig</span>.</span></span>cpp removed from the configuration table</span><br></pre></td></tr></table></figure>

<p>从<code>OpenBTS 5.0</code>开始，可以给<code>OpenBTS</code>的各个子系统组分别定义日志等级，共包括以下组：</p>
<figure class="highlight mathematica"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Log</span>.<span class="keyword">Level</span>.<span class="keyword">Control</span></span><br><span class="line"><span class="keyword">Log</span>.<span class="keyword">Level</span>.SIP</span><br><span class="line"><span class="keyword">Log</span>.<span class="keyword">Level</span>.GSM</span><br><span class="line"><span class="keyword">Log</span>.<span class="keyword">Level</span>.GPRS</span><br><span class="line"><span class="keyword">Log</span>.<span class="keyword">Level</span>.Layer2</span><br><span class="line"><span class="keyword">Log</span>.<span class="keyword">Level</span>.SMS</span><br></pre></td></tr></table></figure>

<p>同样的，这些都是自定义的键值/参数，必须用<code>rawconfig</code>命令进行配置，然后删除用<code>rmconfig</code>命令：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;  rawconfig <span class="keyword">Log</span>.<span class="keyword">Level</span>.SIP <span class="keyword">DEBUG</span></span><br><span class="line">defined <span class="built_in">new</span> config <span class="keyword">Log</span>.<span class="keyword">Level</span>.SIP <span class="keyword">as</span> "DEBUG"</span><br><span class="line"></span><br><span class="line">OpenBTS&gt; rmconfig <span class="keyword">Log</span>.<span class="keyword">Level</span>.SIP</span><br><span class="line"><span class="keyword">Log</span>.<span class="keyword">Level</span>.SIP removed <span class="keyword">from</span> the <span class="keyword">configuration</span> <span class="keyword">table</span></span><br></pre></td></tr></table></figure>

<p>如果给范围组件使用<code>DEBUG</code>级别产生太多了信息，会影响<code>OpenBTS</code>系统运行，所以<code>DEBUG</code>级别只能用于单个源文件或者日志组。</p>
<h2 id="0x230-环境调优"><a href="#0x230-环境调优" class="headerlink" title="0x230 环境调优"></a>0x230 环境调优</h2><p>让<code>OpenBTS</code>适应所部署运行的环境是很重要的一个步骤，周围的建筑、树木、天气、所在高度、天线的选择、电缆长度和功放功率都会有影响。在商业化运作都靠这个领域专业的技术和硬件，但这方面太宽泛了，所以在这里介绍一个比较有效的方法。任何有效的部署，都需要做软件和硬件方面的调优。现在就介绍下<code>OpenBTS</code>软件中提供的控件。</p>
<h3 id="0x231-未入网手机"><a href="#0x231-未入网手机" class="headerlink" title="0x231 未入网手机"></a>0x231 未入网手机</h3><p>如果你在部署时候用了<code>RF信号放大器</code>让信号更强干扰更小，并且区域内其他的载波信号很弱甚至没有，那当地所有的未入网手机都会试图接入网络，因为它们没有别的网络可以接入，这个问题在农村地区很普遍。而大多数人都有手机，当区域内突然有一个基站时候，可能会有几千台手机同时请求入网，基站会被<code>DDOS</code>导致正常的入网请求无法响应。有超过20种方法拒绝这些请求，关键是需要正确的部署配置。默认情况下<code>OpenBTS</code>使用很友好的拒绝方式<code>(0x04)</code>，可以允许该手机在几分钟后重试。你需要告知手机拒绝入网的原因，让它离开一段时间防止<code>LUR</code>认证服务不被拥堵到无法使用的地步。</p>
<p>有两个参数用来定义拒绝入网原因：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>RejectCause</span><br><span class="line">Control.LUR.404RejectCause 0x04     [default]</span><br><span class="line">Control.LUR.UnprovisionedRejectCause 0x04     [default]</span><br></pre></td></tr></table></figure>
<p><code>Control.LUR.404RejectCause</code>键值的含义是，当一个未知用户试图接入网络的时用什么理由拒绝它，不管实际是什么理由拒绝，这里统一用一个参数表示拒绝理由，具体参加对应关系见下表：</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>0x02</td>
<td>IMSI unknown in HLR</td>
</tr>
<tr>
<td>0x04</td>
<td>IMSI unknown in VLR</td>
</tr>
<tr>
<td>0x05</td>
<td>IMEI not accepted</td>
</tr>
<tr>
<td>0x0B</td>
<td>PLMN not allowed</td>
</tr>
<tr>
<td>0x0C</td>
<td>Location area not allowed</td>
</tr>
<tr>
<td>0x0D</td>
<td>Roaming not allowed in this location area</td>
</tr>
<tr>
<td>0x11</td>
<td>Network failure</td>
</tr>
<tr>
<td>0x16</td>
<td>Congestion</td>
</tr>
<tr>
<td>0x20</td>
<td>Service option not supported</td>
</tr>
<tr>
<td>0x21</td>
<td>Requested service option not subscribed</td>
</tr>
<tr>
<td>0x22</td>
<td>Service option temporarily out of order</td>
</tr>
<tr>
<td>0x26</td>
<td>Call cannot be identified</td>
</tr>
<tr>
<td>0x30</td>
<td>Retry upon entry into a new cell</td>
</tr>
<tr>
<td>0x5F</td>
<td>Semantically incorrect message</td>
</tr>
<tr>
<td>0x60</td>
<td>Invalid mandatory information</td>
</tr>
<tr>
<td>0x61</td>
<td>Message type nonexistent or not implemented</td>
</tr>
<tr>
<td>0x62</td>
<td>Message type not compatible with the protocol state</td>
</tr>
<tr>
<td>0x63</td>
<td>Information element nonexistent or not implemented</td>
</tr>
<tr>
<td>0x64</td>
<td>Conditional IE error</td>
</tr>
<tr>
<td>0x65</td>
<td>Message not compatible with the protocol state</td>
</tr>
<tr>
<td>0x6F</td>
<td></td>
</tr>
</tbody></table>
<p>每种参数在手机上可能会有多种效果，经过测试，一些比较常用的，比如<code>0x0C</code>和<code>0x0D</code>，都是告诉非许可手机长时间不再尝试加入网络，且不会影响手机接入其他网络，改这两个值可以极大的减少<code>LUR</code>认证的负载。</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.404RejectCause 0x0C</span><br><span class="line">Control.LUR.404RejectCause changed <span class="keyword">from</span> <span class="string">"0x04"</span> <span class="keyword">to</span> <span class="string">"0x0C"</span></span><br></pre></td></tr></table></figure>

<h3 id="0x232-覆盖区域"><a href="#0x232-覆盖区域" class="headerlink" title="0x232 覆盖区域"></a>0x232 覆盖区域</h3><p>另一种方法就是让手机无法找到你的网络，这是通过硬件和软件的调整来改变覆盖区域的。</p>
<p>短信和注册服务的覆盖区域大概是语音服务的4倍(2倍半径)，因为只要服务正常运行，哪怕丢帧也会再重传的。</p>
<p><code>OpenBTS</code>硬件具备功率控制机制，能够对发射功率进行衰减调节，从而扩大或者缩小覆盖范围，检查基站的当前衰减级别，用<code>power</code>命令：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; <span class="built_in">power</span></span><br><span class="line">current downlink <span class="built_in">power</span> -<span class="number">20</span> <span class="built_in">dB</span> wrt full scale</span><br></pre></td></tr></table></figure>

<p>要调节衰减级别，在<code>power</code>命令后面加参数就行了，如果想基站具备最大功率从而覆盖最大范围，应该将调整为衰减<code>0db</code>：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; <span class="built_in">power</span> <span class="number">0</span></span><br><span class="line">current downlink <span class="built_in">power</span> <span class="number">0</span> <span class="built_in">dB</span> wrt full scale</span><br></pre></td></tr></table></figure>
<p>相反，如果想增大衰减级别减小功耗缩小覆盖区域：</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; <span class="built_in">power</span> <span class="number">20</span></span><br><span class="line">current downlink <span class="built_in">power</span> -<span class="number">20</span> <span class="built_in">dB</span> wrt full scale</span><br></pre></td></tr></table></figure>

<p>还有另一种物理层次的电源控制机制。手机会调整给发送数据的功率，使基站收到的所有手机的信号强度差不多。基站控制着手机和基站通讯的功耗，我们可以限制这个范围。手机是不能控制自己的功率的，所以我们告诉它们所用的功率范围是可以限制的。所用的键值是<code>MS.Power</code>：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">MS</span><span class="selector-class">.Power</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.MS</span><span class="selector-class">.Power</span><span class="selector-class">.Damping</span> 75     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.MS</span><span class="selector-class">.Power</span><span class="selector-class">.Max</span> 33     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.MS</span><span class="selector-class">.Power</span><span class="selector-class">.Min</span> 5     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<p>尽管这种方法很少用到，但至少是一种方法。</p>
<h3 id="0x233-策略性收缩"><a href="#0x233-策略性收缩" class="headerlink" title="0x233 策略性收缩"></a>0x233 策略性收缩</h3><p>利用物理方法收缩区域可能会影响高负载情况下的网络稳定，还有一个参数可以派上用场，<code>GSM.MS.TA.MAX</code>：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">GSM</span><span class="selector-class">.MS</span><span class="selector-class">.TA</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.MS</span><span class="selector-class">.TA</span><span class="selector-class">.Damping</span> 50     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.MS</span><span class="selector-class">.TA</span><span class="selector-class">.Max</span> 62     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<p><code>TA</code>的意思是<code>Timing Advance</code>(定时提前)，定时提前是GSM用来给距离基站非常远的手机的补偿方法，越远的手机<code>TA</code>值越大。这个值告诉手机提前多少时间发送脉冲信号，那样当基站给手机分配时隙的时候刚好到达。电磁波的传输速度很快，但仍然不是瞬间到达。</p>
<p>回到参数设定：比如将<code>GSM.MS.TA.MAX</code>设置成<code>10</code>，<code>OpenBTS</code>会默默的忽略任何<code>TA</code>大于<code>10</code>的无线电信号。<code>TA</code>经过一种叫信号周期的测试大概每单位对应<code>550m</code>距离。将<code>GSM.MS.TA.MAX</code>设置为<code>10</code>，表示<code>OpenBTS</code>会忽略范围<code>5.5km</code>之外的任何手机信号。</p>
<p>但覆盖区基本都不是正圆，就是由于策略限制，如果信号塔在一个山谷，高处的三个方向会被抑制，但其余的方向就能收到更远基站的信号。你不想降低功率，因为山坡上也有用户，所以，这种情况下就能通过策略开限制覆盖区域。</p>
<h3 id="0x234-信号失真"><a href="#0x234-信号失真" class="headerlink" title="0x234 信号失真"></a>0x234 信号失真</h3><p>信号失真是受安装地形周围环境的严重影响，缺省配置下，<code>OpenBTS</code>的配置成全力消除多路失真。它通过尽量开大时间窗来抵消信号失真，这是很费系统资源的计算。</p>
<p>如果你是在地势很开阔的地段，没有任何建筑和树木，可以通过调整<code>GSM.Radio.MaxExpectedDelaySpread</code>来降低CPU负载，区域覆盖越小，参数数值越小：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Delay</span><br><span class="line">GSM.Radio.MaxExpectedDelaySpread 4     [default]</span><br></pre></td></tr></table></figure>

<p>这个键值决定了检查的符号周期，如果把参值调小之后效果不好，就调回默认值<code>4</code>。</p>
<h3 id="0x235-信号更强，抗干扰更佳"><a href="#0x235-信号更强，抗干扰更佳" class="headerlink" title="0x235 信号更强，抗干扰更佳"></a>0x235 信号更强，抗干扰更佳</h3><p>为了有效的增大生产环境网络覆盖面，你需要一个信号放大器和空腔双工器，因为GSM手机一般有2W以上的发射功率，但你的SDR只有100mW的发射功率，所以基站成为限制覆盖区域的主要因素。上行链路的信号是从手机发往基站的，但下行链路型号是从基站到手机的，这个信号对手机来说太弱了。基站和手机之间功率不对称，示意图如下：</p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445681.png" alt=""></p>
<p>为了说明问题，在基站的发射链路上加一个2W的信号放大器来增大覆盖范围，但接收链路的问题也要注意，因为接收天线从发射天线收到的信号强度也会大大增加，这会损坏SDR的电路。至少，想要解调一个干净的信号是不大可能的，因为发送端2W的信号放大器产生的噪声足以淹没任何远处的手机，要想解决这个问题，还需要一个空腔双工器。</p>
<p>空腔双工器连接到发射和接收的天线接口，然后从双工器引出一根天线，连接示意图如下：</p>
<p><code>GSM</code>发射和接收是在不同的频率，所以双工器能够干净的分离出发射和接收信号，这样可以防止不必要的发射链路信号回环到接收链路。因为这个分离是基于频率的，所以双工器必须选择能够匹配<code>GSM</code>频段<code>850,900,1800以及1900</code>的。</p>
<h1 id="从单路到多路"><a href="#从单路到多路" class="headerlink" title="从单路到多路"></a>从单路到多路</h1><p>一个基站就可以建立移动网络，但当到了某个程度时候，不管那个那个基站如何调优，都不能有效的覆盖目标区域。由于<code>OpenBTS</code>是用同一套软件实现不同大小区域的覆盖，甚至可以在一台树莓派上运行。现在可以抛弃传统手机信号塔的模式了，你甚至可以把基站装进鞋盒或者和Wifi热点结合到一起。</p>
<p>这里就介绍如何将移动网络扩展到多个物理基站，但仍然是在一个逻辑网络里面，这个逻辑网络可以便捷移动以及迅速部署成运营网络。</p>
<h2 id="0x310-移动性、切换和漫游"><a href="#0x310-移动性、切换和漫游" class="headerlink" title="0x310 移动性、切换和漫游"></a>0x310 移动性、切换和漫游</h2><p>目前这个方面的概念有些混乱，虽然它们的意思很明白的事情，但即使这个领域的专家围绕这个一起讨论，也很难让别人接受他们的看法，所以为了杜绝不确定性，每个名词都做了简要概述：</p>
<h3 id="0x311-移动性"><a href="#0x311-移动性" class="headerlink" title="0x311 移动性"></a>0x311 移动性</h3><p><code>移动性</code>是指一个手机能够收到不同物理基站提供的不同运营商网络。假如一个手机在三维空间中移动时候，它收到来自附近基站的信号强度和质量就会波动，而手机在收到附近一个更强的基站信号时，就会发送一个<code>LUR</code>入网注册请求或者入网请求，不同的是，在同一个基站中周期性的<code>LUR</code>会更新注册信息，如果是在一个新的基站，<code>LUR</code>就是接入并切换到这个网络的请求了。</p>
<p>除非两个基站有不同的<code>位置区编码LACs</code>，<code>LUR</code>请求是不会被执行的。在传统的GSM网络中，在一个特定的区域里所有的基站都有一样的<code>LAC</code>。但目前的<code>OpenBTS</code>要求所有的基站都具有唯一的<code>LAC</code>，所以手机在两个基站之间移动时候<code>LUR</code>会被执行。这会触发一个更新<code>SIP REGISTER</code>信息的请求，并且给这个新基站的IP一个注册用户的更新请求。</p>
<p><code>移动性</code>是网络的一个功能，并且由手机决定接入哪个基站。另外，这只可能是手机没在进行短信或者电话等业务执行的时候。<code>移动性</code>也可以称为<code>入网空闲模式</code>。</p>
<h3 id="0x312-切换"><a href="#0x312-切换" class="headerlink" title="0x312 切换"></a>0x312 切换</h3><p><code>切换</code>是保证一个有效的语音通话能在两个基站之间切换的能力。<code>流动性</code>是<code>切换</code>的先决条件，但不同的是，这是是由网络决定并执行的。</p>
<p>传统GSM网络通过<code>基站控制器BSC</code>控制<code>切换</code>，而<code>OpenBTS</code>省去了<code>BSC</code>用一种新的<code>端对端协定传输技术P2PP</code>技术。周边频率信息、身份信息、活动信息都通过这个协议交换，极大简化了结构体系的部署。</p>
<p>决定<code>切换</code>还有几个因素。首先，来自基站的下行链路信号对当前手机必须够弱；其次，附近基站的信号强度也必须超过能够提供基站服务的阈值；最后，附近信号最强的基站现在没有因为拥护拒绝所有的<code>切换</code>请求。满足这些条件后，现在服务的基站会发出一个<code>切换</code>请求给附近信号最强的基站。</p>
<h3 id="0x313-漫游"><a href="#0x313-漫游" class="headerlink" title="0x313 漫游"></a>0x313 漫游</h3><p><code>漫游</code>是跨运营商的<code>移动</code>，它需要那些运营商和通用接口技术的管理协议，通常GSM移动通信应用部分(MAP)发送<code>SS7</code>指令网络。所以，在你自己的私人网络里面是不可能实现漫游功能的。</p>
<h2 id="0x320-拓扑结构"><a href="#0x320-拓扑结构" class="headerlink" title="0x320 拓扑结构"></a>0x320 拓扑结构</h2><p>到现在为止，你已经建立了一个<code>单点网络 (Network-in-a-Box)</code>的拓扑结构，可以在每一个逻辑实体、服务器节点的组件上。在一个多节点网络中存在两种逻辑实体：中控服务器和信号塔。你迄今为止所熟悉的组件需要重新部署一下才能支持这种结构。中控服务器需要安装<code>SIPAuthServe，SMQueue和Asterisk</code>服务，为了简单起见，在这部分内容里这三种服务统称<code>中控服务</code>。信号塔只允许<code>OpenBTS</code>。</p>
<p>下图是一个单中控服务器和多信号卡的多节点拓扑结构示意图：</p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445692.png" alt=""></p>
<p>信号塔数据通过<code>IP</code>发回中控服务器，这样就可以覆盖多个区域并且互相共享注册用户的数据库和配置。</p>
<p>下面的说明中，中控服务器IP为<code>192.168.158.100</code>，信号塔的IP从<code>192.168.158.201</code>开始。</p>
<h2 id="0x330-中控服务器配置"><a href="#0x330-中控服务器配置" class="headerlink" title="0x330 中控服务器配置"></a>0x330 中控服务器配置</h2><p>不是说从现有的单节点网络中提取中控服务，把<code>OpenBTS</code>的硬件和应用迁移到新环境更简单。这样就不需要迁移<code>SIPAuthServe，SMQueue和Asterisk</code>服务的用户数据以及配置。</p>
<h3 id="0x331-卸载OpenBTS"><a href="#0x331-卸载OpenBTS" class="headerlink" title="0x331 卸载OpenBTS"></a>0x331 卸载OpenBTS</h3><p>为了确保<code>OpenBTS</code>不被开机自动启动，防止因为没有硬件导致启动失败并不断重试，我们需要卸载掉<code>OpenBTS</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-<span class="builtin-name">get</span> <span class="builtin-name">remove</span> openbts</span><br></pre></td></tr></table></figure>

<h3 id="0x332-配置日志记录"><a href="#0x332-配置日志记录" class="headerlink" title="0x332 配置日志记录"></a>0x332 配置日志记录</h3><p>每个独立的信号塔和中控服务一样，都会产生日志信息，所以需要设置一下中控服务，来接收整个网络所有信号塔的日志到一个文件。</p>
<p>这一步不是建立一个多节点网络，但在调试时候非常有用，在多个日志文件中跟踪多个信号塔的错误日志是一个很坑的事情。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi <span class="regexp">/etc/</span>rsyslog.conf </span><br><span class="line"></span><br><span class="line">取消两行注释，开启UDP的系统日志接收功能</span><br><span class="line"></span><br><span class="line"><span class="comment"># provides UDP syslog reception</span></span><br><span class="line"><span class="variable">$ModLoad</span> imudp</span><br><span class="line"><span class="variable">$UDPServerRun</span> <span class="number">514</span></span><br></pre></td></tr></table></figure>

<p>这两行配置的意思<code>rsyslog</code>服务开启<code>514</code>端口的<code>UDP</code>服务来接收日志。要启用这个配置需要重启服务：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">service rsyslog restart</span></span><br></pre></td></tr></table></figure>

<h3 id="0x333-SIPAuthServe，SMQueue和Asterisk服务"><a href="#0x333-SIPAuthServe，SMQueue和Asterisk服务" class="headerlink" title="0x333 SIPAuthServe，SMQueue和Asterisk服务"></a>0x333 SIPAuthServe，SMQueue和Asterisk服务</h3><p>这些服务不需要重新配置，它们不管<code>OpenBTS</code>是通过硬件进行通信还是IP网络进行通讯。</p>
<h2 id="0x340-信号塔配置"><a href="#0x340-信号塔配置" class="headerlink" title="0x340 信号塔配置"></a>0x340 信号塔配置</h2><p>重新配置一个系统并运行各个服务器组件，不管是在物理机还是虚拟机，不过必须要用不同的主机名用来区分日志。另外，可以只安装<code>OpenBTS</code>服务来节省时间。</p>
<p>信号塔和中控服务器必须在同一网段，在信号塔上启用日志之后，确保可以<code>ping</code>通中控服务器：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ping -c <span class="number">4</span> <span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span></span><br><span class="line">PING <span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span> (<span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of data.</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span>: icmp_req=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.046</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span>: icmp_req=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.023</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span>: icmp_req=<span class="number">3</span> ttl=<span class="number">64</span> time=<span class="number">0.022</span> ms</span><br><span class="line"><span class="number">64</span> bytes <span class="keyword">from</span> <span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span>: icmp_req=<span class="number">4</span> ttl=<span class="number">64</span> time=<span class="number">0.025</span> ms</span><br><span class="line"> </span><br><span class="line">--- <span class="number">192.168</span><span class="number">.158</span><span class="number">.100</span> ping statistics ---</span><br><span class="line"><span class="number">4</span> packets transmitted, <span class="number">4</span> received, <span class="number">0</span>% packet loss, time <span class="number">2997</span>ms</span><br><span class="line">rtt min/avg/max/mdev = <span class="number">0.022</span>/<span class="number">0.029</span>/<span class="number">0.046</span>/<span class="number">0.009</span> ms</span><br></pre></td></tr></table></figure>

<h3 id="0x341-配置SIP代理"><a href="#0x341-配置SIP代理" class="headerlink" title="0x341 配置SIP代理"></a>0x341 配置SIP代理</h3><p><code>OpenBTS</code>使用<code>SIP</code>连接其他组件的，现在这些组件安装在别的机器上，所以<code>SIP.Proxy</code>键值需要做相应调整。默认情况下<code>Openbts</code>连接服务的<code>IP</code>地址都是本地<code>localhost</code>。<code>SIP.Local.IP</code>键值可以设置其他服务连接<code>OpenBTS</code>时或者回复它们的请求时应该使用的<code>IP</code>地址。设置信号塔命令如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">SIP</span><span class="selector-class">.Local</span><span class="selector-class">.IP</span> 192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.201</span></span><br><span class="line"><span class="selector-tag">SIP</span><span class="selector-class">.Local</span><span class="selector-class">.IP</span> <span class="selector-tag">changed</span> <span class="selector-tag">from</span> "127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span>" <span class="selector-tag">to</span> "192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.201</span>"</span><br><span class="line"><span class="selector-tag">SIP</span><span class="selector-class">.Local</span><span class="selector-class">.IP</span> <span class="selector-tag">is</span> <span class="selector-tag">static</span>; <span class="selector-tag">change</span> <span class="selector-tag">takes</span> <span class="selector-tag">effect</span> <span class="selector-tag">on</span> <span class="selector-tag">restart</span></span><br></pre></td></tr></table></figure>

<p>设置完成后需要重启<code>OpenBTS</code>服务才能生效：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">stop</span> openbts</span><br><span class="line"><span class="literal">start</span> openbts</span><br></pre></td></tr></table></figure>

<p>现在每个<code>SIP.Proxy</code>键值都会更新到转向中控服务器，同样的，注册、语音、短信服务都要从本地改为中控服务器：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">SIP</span><span class="selector-class">.Proxy</span><span class="selector-class">.Registration</span> 192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.100</span><span class="selector-pseudo">:5064</span></span><br><span class="line"><span class="selector-tag">SIP</span><span class="selector-class">.Proxy</span><span class="selector-class">.Registration</span> <span class="selector-tag">changed</span> <span class="selector-tag">from</span> "127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:5064"</span> <span class="selector-tag">to</span> "192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.100</span><span class="selector-pseudo">:5064"</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">SIP</span><span class="selector-class">.Proxy</span><span class="selector-class">.SMS</span> 192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.100</span><span class="selector-pseudo">:5063</span></span><br><span class="line"><span class="selector-tag">SIP</span><span class="selector-class">.Proxy</span><span class="selector-class">.SMS</span> <span class="selector-tag">changed</span> <span class="selector-tag">from</span> "127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:5063"</span> <span class="selector-tag">to</span> "192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.100</span><span class="selector-pseudo">:5063"</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">SIP</span><span class="selector-class">.Proxy</span><span class="selector-class">.Speech</span> 192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.100</span><span class="selector-pseudo">:5060</span></span><br><span class="line"><span class="selector-tag">SIP</span><span class="selector-class">.Proxy</span><span class="selector-class">.Speech</span> <span class="selector-tag">changed</span> <span class="selector-tag">from</span> "127<span class="selector-class">.0</span><span class="selector-class">.0</span><span class="selector-class">.1</span><span class="selector-pseudo">:5060"</span> <span class="selector-tag">to</span> "192<span class="selector-class">.168</span><span class="selector-class">.158</span><span class="selector-class">.100</span><span class="selector-pseudo">:5060"</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：一定要确定包括端口信息，每个组件都运行在不同的端口，如果在错误的端口请求路由会影响功能。</strong></p>
<p>用手机手动选择并注册这个新的拓扑做下测试，走动之前确认下语音和短信都能用。</p>
<h3 id="0x342-配置日志记录"><a href="#0x342-配置日志记录" class="headerlink" title="0x342 配置日志记录"></a>0x342 配置日志记录</h3><p>每个信号塔产生的日志信息都会被发送到中控服务器，在中控服务器的日志守护进程已经修改过配置能够接收这些数据，现在我们告诉我们的信号塔发送日志：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi  /etc/rsyslog.d/<span class="module-access"><span class="module"><span class="identifier">OpenBTS</span>.</span></span>conf</span><br><span class="line"></span><br><span class="line">最下面添加一行</span><br><span class="line">local7.*              /var/log/<span class="module-access"><span class="module"><span class="identifier">OpenBTS</span>.</span></span>log</span><br><span class="line">local7.*              @the-central-services-ip</span><br></pre></td></tr></table></figure>

<p>这行配置的意思是，日志信息除了会记录到硬盘上的<code>/var/log/OpenBTS.log</code>文件，还会发送到中控服务器的日志记录。要启用这个设置，也需要重启服务：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">service rsyslog restart</span></span><br></pre></td></tr></table></figure>

<h3 id="0x343-拓扑网络重构"><a href="#0x343-拓扑网络重构" class="headerlink" title="0x343 拓扑网络重构"></a>0x343 拓扑网络重构</h3><p>到目前为止，现在网络的功能和之前是相同的，依然是一个由中控服务器和逻辑信号塔构成的覆盖区域，仅仅是从一个物理机分割成两个独立的物理机。下一步将把附近的信号塔添加到网络，并让它们显示成同一个<code>RAN</code>。</p>
<h2 id="0x350-添加附近信号塔"><a href="#0x350-添加附近信号塔" class="headerlink" title="0x350 添加附近信号塔"></a>0x350 添加附近信号塔</h2><p>你现在可以重复添加很多个物理信号塔，每一个都配制成功能极少的独立信号塔，并且在网络内充当合适位置的信号塔。此外，每个已有信号塔必须知道新的信号塔。</p>
<p>假设现在你的网络里只有一个信号塔，一个刚刚从单点网络调整过来，先看看它的参数：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">Identity</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.BSIC</span><span class="selector-class">.BCC</span> 2     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.BSIC</span><span class="selector-class">.NCC</span> 0     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.CI</span> 10     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.LAC</span> 1000     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.MCC</span> 001     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.MNC</span> 01     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.ShortName</span> <span class="selector-tag">White</span></span><br></pre></td></tr></table></figure>

<p>这些参数中，有一些必须是唯一的而其他的必须是所有信号塔完全相同的，下面是一个配置列表，告诉你那些键值必须是唯一的哪些必须是统一的。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">统一</span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.MCC</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.MNC</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.BSIC</span><span class="selector-class">.NCC</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.CellSelection</span><span class="selector-class">.NCCsPermitted</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.ShortName</span></span><br><span class="line"></span><br><span class="line">唯一</span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.LAC</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.CI</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Identity</span><span class="selector-class">.BSIC</span><span class="selector-class">.BCC</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Radio</span><span class="selector-class">.C0</span></span><br></pre></td></tr></table></figure>

<p>展现一些潜藏的信息，理解每个参数，再依据一步步的指引配置你的下一个信号塔。</p>
<h3 id="0x351-必须统一"><a href="#0x351-必须统一" class="headerlink" title="0x351 必须统一"></a>0x351 必须统一</h3><p><code>GSM.Identity.MCC</code>和<code>GSM.Identity.MNC</code>键值对于任何网络都是最高级别的认证，表明这个网络是哪个国家的哪个运营商在运营。这两个ID是监管机构分配的。测试网络通常用的分别是<code>001</code>和<code>01</code>。如果这不是一个测试网络，你必须注意这个参数，否则你可能需要花钱购买许可。</p>
<p><code>GSM.Identity.BSIC.NCC</code>是你的<code>网络色码(NCC)</code>，一段手机用来快速确定否能访问网络的信息。在指定区域内的所有运营商必须具有唯一的色码。</p>
<p>最后一个关键的键值是<code>GSM.CellSelection.NCCsPermitted</code>，这个键值是在和其他网络合作时候告知”不只我这个NCC OK，还有其他的一些NCC是可用的”，<code>NCCsPermitted</code>键值是按位标志而不是一个整数值。总之，所有的信号塔的<code>NCCsPermitted</code>配置必须相同。</p>
<p><code>GSM.Identity.ShortName</code>键值也是所有信号塔相同的，但这不是必要条件，在部署调试一个多节点网络时候，为了调试的方便一般会给每个信号塔一个独特的短名，这样你可以知道你手机目前驻留在那个信号塔然后离开它。</p>
<h4 id="设置步骤"><a href="#设置步骤" class="headerlink" title="设置步骤"></a>设置步骤</h4><p>这部分的说明很简单很基础，就是确保在同一个网络中现有的信号塔的这些键值都相同。</p>
<h3 id="0x352-必须唯一"><a href="#0x352-必须唯一" class="headerlink" title="0x352 必须唯一"></a>0x352 必须唯一</h3><p>第一个键值，<code>GSM.Radio.C0</code>必须是唯一的，因为这是<code>ARFCN</code>并且由此决定这个信号塔的<code>RF</code>频段。如果物理上两个相近的信号塔用相同频率，会在重叠区域内产生干扰并且拒绝这个区域内所有用户的服务。</p>
<p><strong>注意：<code>C0 ARFCNs</code>不仅仅要求唯一还要求不相邻，因为信道间隔只有<code>200KHz</code>而信道宽度有<code>270KHz</code>，相邻的<code>ARFCN</code>也会重叠。所以部署相邻的信号塔至少要间隔1个<code>ARFCN</code>(比如塔1用<code>ARFCN151</code>，塔2用<code>ARFCN153</code>)。</strong></p>
<p><code>GSM.Identity.BSIC.BCC</code>相邻的信号塔也必须是不同的，这代表基站色码<code>BCC</code>，是一个3位二进制，一共有7个不同的值。</p>
<p>你得到许可的<code>C0 ARFCNs</code>和<code>BCC</code>的数量很有限，参照下面的彩图对塔的参数分配很有帮助。彩图标识了所有信号塔的地理位置以及分配的颜色，每种颜色对应一种<code>ARFCN</code>和<code>BCC</code>。如果你的规划没有两个相邻的信号塔会有同样的颜色，那么移动性和切换就不会因为<code>ARFCNs</code>或者<code>BCC</code>所阻碍。</p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445694.png" alt=""></p>
<p>网络中所有的信号塔的<code>GSM.Identity.LAC</code>键值必须各不相同，当手机在跨区域移动时候会感觉到位置区码<code>LAC</code>在发生变化，然后会执行<code>LUR</code>请求，这个<code>LUR</code>请求会发送一个<code>SIP REGISTER</code>注册请求，<code>SIPAuthServe</code>服务收到后会更新这个手机可以接入的信号塔的IP地址。这个唯一性要求只针对于<code>OpenBTS</code>，传统网络的<code>LACs</code>了包含大的多的区域里面很多个信号塔。</p>
<p><code>GSM.Identity.CI</code>指的是小区识别码<code>CI</code>，同样要求全网唯一。</p>
<h4 id="设置步骤-1"><a href="#设置步骤-1" class="headerlink" title="设置步骤"></a>设置步骤</h4><p>给新的信号塔分配颜色，并使用相对应的<code>C0</code>和<code>BCC</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Radio.C0 168</span><br><span class="line">GSM.Radio.C0 changed <span class="keyword">from</span> <span class="string">"151"</span> <span class="keyword">to</span> <span class="string">"168"</span></span><br><span class="line">GSM.Radio.C0 is static; change takes effect on restart</span><br><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Identity.BSIC.BCC 3</span><br><span class="line">GSM.Identity.BSIC.BCC changed <span class="keyword">from</span> <span class="string">"2"</span> <span class="keyword">to</span> <span class="string">"3"</span></span><br></pre></td></tr></table></figure>

<p>由于有足够多的<code>LAC</code>和<code>CI</code>值，只需每个塔的值递增一下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Identity.LAC 1001</span><br><span class="line">GSM.Identity.LAC changed <span class="keyword">from</span> <span class="string">"1000"</span> <span class="keyword">to</span> <span class="string">"1001"</span></span><br><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Identity.CI 11</span><br><span class="line">GSM.Identity.CI changed <span class="keyword">from</span> <span class="string">"10"</span> <span class="keyword">to</span> <span class="string">"11"</span></span><br></pre></td></tr></table></figure>
<p>重启<code>OpenBTS</code>服务是变更生效：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">stop</span> openbts</span><br><span class="line"><span class="literal">start</span> openbts</span><br></pre></td></tr></table></figure>

<h3 id="0x353-附近基站列表和命令"><a href="#0x353-附近基站列表和命令" class="headerlink" title="0x353 附近基站列表和命令"></a>0x353 附近基站列表和命令</h3><p>你的信号塔现在已经配置完了，按照它们逻辑规划的ID编号通过物理方法传输它们的频率会很麻烦，它们还必须告知彼此自己的配置，这就需要用<code>GSM.Neighbors</code>键值完成。每个信号塔必须有和IP地址一致的<code>GSM.Neighbors</code>键值，用来设置出自身以外的所有信号塔的空间隔离清单。</p>
<p>在你的新信号塔<code>192.168.158.202</code>，需要输入以下命令告诉它你原来的信号塔：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Neighbors 192.168.158.201</span><br><span class="line">GSM.Neighbors changed <span class="keyword">from</span> <span class="string">""</span> <span class="keyword">to</span> <span class="string">"192.168.158.201"</span></span><br></pre></td></tr></table></figure>

<p>同样的在你的原信号塔你需要告诉它新信号塔：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GSM.Neighbors 192.168.158.202</span><br><span class="line">GSM.Neighbors changed <span class="keyword">from</span> <span class="string">""</span> <span class="keyword">to</span> <span class="string">"192.168.158.202"</span></span><br></pre></td></tr></table></figure>

<p>还是在你的原信号塔<code>192.168.158.201</code>，用检查附近信号塔的命令：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; neighbors</span><br><span class="line">host                  C0  BSIC FreqIndex Noise ARFCNs TCH-Avail Updated Holdoff</span><br><span class="line">------------------    --- ---- --------- ----- ------ --------- ------- -------</span><br><span class="line"><span class="number">192.168</span><span class="number">.158</span><span class="number">.202</span>:<span class="number">16001</span> <span class="number">168</span> <span class="number">2</span>    <span class="number">0</span>         <span class="number">68</span>    <span class="number">1</span>      <span class="number">7</span>         <span class="number">16</span>      <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p><code>OpenBTS</code>会依据对等协议从<code>GSM.Neighbors</code>中自动查询附近的基站信息。用<code>neighbors</code>命令可以看到<code>C0 ARFCN，噪声等级，ARFCN总数和可用业务信道(TCHs)</code>。</p>
<h3 id="0x354-Neighbor-Enabled命令"><a href="#0x354-Neighbor-Enabled命令" class="headerlink" title="0x354 Neighbor-Enabled命令"></a>0x354 Neighbor-Enabled命令</h3><p>现在，你有一些功能有效的附近基站，用<code>chans</code>命令也能在通话过程中显示很多有用的信息。这个信息包含了手机报告的附近最强信号的信号塔提供的信号接收等级，用<code>chans -l</code>命令就可以看到：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; chans -l</span><br><span class="line">CN TN chan  transaction LAPDm           recyc Signal RSSI RSSP SNR  FER   BER TA</span><br><span class="line">     <span class="built_in"> type </span> id          state                 dB     dB   dB        pct   pct sym</span><br><span class="line">0  1  TCH/F T100        LinkEstablished <span class="literal">false</span> 26     -50  -24  38.7 0.00  0   0.9</span><br><span class="line">                  TXPWR TA_DL RXLEV_DL BER_DL Time IMSI    <span class="built_in"> Neighbor </span>   Handover</span><br><span class="line">                  dBm   sym   dBm      pct    M:S           ARFCN(dBm)  C0:BSIC</span><br><span class="line">                  7     0     -93      2.26   0:25 2140<span class="built_in">..</span>.  168         (-76)</span><br></pre></td></tr></table></figure>

<h3 id="0x355-覆盖范围重叠"><a href="#0x355-覆盖范围重叠" class="headerlink" title="0x355 覆盖范围重叠"></a>0x355 覆盖范围重叠</h3><p>单独调节每个信号塔，最棘手的就是处理它们之间的关系，再看下面这张图，塔1和塔2的重叠区域很重要。这个区域必须足够宽，使得手机只要通过<code>切换</code>就能与两个塔中任何一个进行可靠的通信，必须考虑这个区域的地形以及手机潜在的速度。但同样的，如果重叠区域太大就浪费了资源。所以，寻找可靠的重叠区域以及优化整体区域的平衡是关键。同样的，商业化运营就建立在这些专业且有深度的知识上，都在这本”getting started”书里面。</p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445693.png" alt=""></p>
<p>手机的移动性只有<code>GSM.CellSelection.CELL-RESELECT-HYSTERESIS</code>键值需要配置，这个键值表明手机在准备重新入网时候，选择附近信号强多少的信号塔。</p>
<p><code>OpenBTS</code>可以直接控制<code>切换</code>，有几个键值是用来调整<code>切换</code>操作的：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">Handover</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.FailureHoldoff</span> 20     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.Margin</span> 15     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.Ny1</span> 50     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.Handover</span><span class="selector-class">.Holdoff</span> 10     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<p><code>GSM.Handover.Margin</code>类似<code>GSM.CellSelection.CELL-RESELECT-HYSTERESIS</code>用于<code>切换</code>操作，这两个设置要注意，如果参值设置的太高(意思是信号塔要比切换前的强太多)，可能会导致手机无法在规定时间内跳转过去，如果参值设置的太低(意思是信号塔只比切换前的强一点点)，手机可能会在这个区域流量峰值时候在两个信号强度相近的信号塔之间来回跳转。</p>
<p>如果你想测试<code>OpenBTS</code>里面的切换算法的权重，可以用<code>devconfig</code>查看更多参数：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">devconfig</span> <span class="selector-tag">Handover</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.FailureHoldoff</span> 20     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.History</span><span class="selector-class">.Max</span> 32     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.Margin</span> 15     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.Ny1</span> 50     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.RXLEV_DL</span><span class="selector-class">.History</span> 6     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.RXLEV_DL</span><span class="selector-class">.Margin</span> 10     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.RXLEV_DL</span><span class="selector-class">.PenaltyTime</span> 20     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Handover</span><span class="selector-class">.RXLEV_DL</span><span class="selector-class">.Target</span> 60     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Timer</span><span class="selector-class">.Handover</span><span class="selector-class">.Holdoff</span> 10     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<h1 id="GPRS"><a href="#GPRS" class="headerlink" title="GPRS"></a>GPRS</h1><p>移动网络已经在世界上很多地方普及了，缺少的是数据网络。比如<code>WhatsApp</code>和<code>Skype</code>这样的<code>OTT</code>服务只需要一个不论什么载体的数据通道。使用者的费用也不取决于地理位置，不像本地的长途费用。</p>
<p><code>GPRS</code>的传输速度对于双向视频流来说是太慢了，但足够支撑低质量的语音通话。它的速度足够email和OTT文字短信使用。世界上的传感器和基础设置比如热流量传感器和电力停车计时器都需要数据连接。这些低带宽的<code>M2M</code>设备现在被称为<code>IOT物联网</code>的设备，普遍使用<code>GPRS</code>。</p>
<p><code>GPRS</code>实际不是<code>GSM</code>的一部门，它是在<code>GSM</code>已经标准化后才开发的，通常被称为<code>2.5G</code>，区别于纯<code>2G</code>的<code>GSM</code>。<code>OpenBTS</code>尽量模糊了这些差异，并提供了一个统一的配置。</p>
<h2 id="0x410-启用-禁用"><a href="#0x410-启用-禁用" class="headerlink" title="0x410 启用/禁用"></a>0x410 启用/禁用</h2><p>默认情况下，<code>OpenBTS</code>中<code>GPRS</code>服务是禁用的，要启用这个服务需要配置<code>GPRS.Enable</code>键值：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GPRS.<span class="builtin-name">Enable</span> 1</span><br><span class="line">GPRS.<span class="builtin-name">Enable</span> changed <span class="keyword">from</span> <span class="string">"0"</span> <span class="keyword">to</span> <span class="string">"1"</span></span><br><span class="line">GPRS.<span class="builtin-name">Enable</span> is static; change takes effect on restart</span><br></pre></td></tr></table></figure>

<p>启用<code>GPRS</code>需要重启<code>OpenBTS</code>服务：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">stop</span> openbts</span><br><span class="line"><span class="literal">start</span> openbts</span><br></pre></td></tr></table></figure>

<p>重启<code>OpenBTS</code>服务以后，可以用<code>gprs list</code>确认<code>OpenBTS</code>建立了几个<code>GPRS</code>通道：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; gprs list</span><br><span class="line">PDCH <span class="attribute">ARFCN</span>=51 <span class="attribute">TN</span>=1 <span class="attribute">FER</span>=0%</span><br><span class="line">PDCH <span class="attribute">ARFCN</span>=51 <span class="attribute">TN</span>=2 <span class="attribute">FER</span>=0%</span><br></pre></td></tr></table></figure>

<h2 id="0x420-中控服务"><a href="#0x420-中控服务" class="headerlink" title="0x420 中控服务"></a>0x420 中控服务</h2><p><code>GPRS</code>不依赖其他任何组件，但Linux主机上的一些配置必须正确才能正常工作。这些在<code>range-configs</code>包被安装时候就已经做好了，但还是需要进行复查。</p>
<p>手机的<code>IP</code>流量是通过<code>OpenBTS</code>建立的一个名为<code>sgsntun</code>虚拟网卡进行通讯的，可以用<code>ifconfig sgsntun</code>命令检查：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ifconfig sgsntun</span><br><span class="line">sgsntun   Link encap:UNSPEC  HWaddr <span class="number">00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span><span class="number">-00</span> </span><br><span class="line">          UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:<span class="number">1500</span>  Metric:<span class="number">1</span></span><br><span class="line">          RX packets:<span class="number">0</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> frame:<span class="number">0</span></span><br><span class="line">          TX packets:<span class="number">0</span> errors:<span class="number">0</span> dropped:<span class="number">0</span> overruns:<span class="number">0</span> carrier:<span class="number">0</span></span><br><span class="line">          collisions:<span class="number">0</span> txqueuelen:<span class="number">500</span></span><br><span class="line">          RX bytes:<span class="number">0</span> (<span class="number">0.0</span> B)  TX bytes:<span class="number">0</span> (<span class="number">0.0</span> B)</span><br></pre></td></tr></table></figure>

<p>这个虚拟网卡需要先配置路由和iptables转发规则。规则样例在<code>/etc/OpenBTS/iptables.rules</code>，需要按照时间情况修改网关和网卡名，默认用的是<code>eth0</code>，使规则生效用的命令：</p>
<figure class="highlight arcade"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables-restore &lt; <span class="regexp">/etc/</span>OpenBTS/iptables.rules</span><br></pre></td></tr></table></figure>

<p>如果想让系统的<code>eth0</code>网卡启动时候能够自动加载规则，就在<code>/etc/network/interfaces</code>网卡配置文件中<code>eth0</code>网卡配置那网卡加上<code>pre-up</code>规则。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">auto</span> <span class="string">eth0 </span></span><br><span class="line"><span class="attr">iface</span> <span class="string">eth0 inet dhcp</span></span><br><span class="line">        <span class="meta">pre-up</span> <span class="string">iptables-restore &lt; /etc/OpenBTS/iptables.rules</span></span><br></pre></td></tr></table></figure>

<p>Linux主机就是作为管道设备通过规则转发让<code>GPRS</code>上网。</p>
<h2 id="0x430-连接"><a href="#0x430-连接" class="headerlink" title="0x430 连接"></a>0x430 连接</h2><p>当你的手机发送<code>LUR</code>请求加入网络时候会做一个备份，因为可能会有额外的步骤来做<code>GPRS</code>的认证和使用。</p>
<p>在<code>GPRS</code>中不叫<code>LUR</code>，叫做<code>GPRS Attach</code>，手机可能会因为几个原因不做<code>Attach</code>操作。</p>
<p>如果你用的是其他运营商的<code>SIM</code>卡，手机的<code>GPRS</code>子系统可能会在加入<code>OpenBTS</code>网络时认为自己漫游了，如果手机没有设置”使用数据漫游”，<code>GPRS</code>子系统不会去尝试接入网络。</p>
<p>请仔细检查你手机的<code>APN</code>接入点设置，<code>OpenBTS</code>不管名称、用户名和密码有什么内容，但手机可能不会在确认这些信息之前发送<code>Attach</code>请求。</p>
<p><code>Android</code>在<code>APN</code>条目有个很奇怪的<code>Bug</code>，在某些版本中，你可以添加一个新的<code>APN</code>，但不会被保存，除非<code>MCC</code>移动国家码和<code>MNC</code>移动网络码和<code>SIM</code>卡中相匹配。这种故障没有提示也没有声音，新的<code>APN</code>设置也不会被启用，也不会在设备的<code>APN</code>列表中显示，但如果你更换了一1个与<code>SIM</code>卡相匹配的<code>MMC</code>和<code>MNC</code>，你的<code>APN</code>信息就会神器的出现。</p>
<p>总之，有些手机会需要好几分钟时间来<code>Attach</code>，在放弃并发起<code>Attach</code>请求之前，它们可能会发送旧的网络访问信息给<code>OpenBTS</code>，当<code>Attach</code>成功后，用<code>sgsn list</code>可以看到手机的<code>IP</code>地址：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; sgsn list</span><br><span class="line">GMM Context: <span class="attribute">imsi</span>=460022016844078 <span class="attribute">ptmsi</span>=0x2b001 <span class="attribute">tlli</span>=0xc002b001 <span class="attribute">state</span>=GmmRegisteredNormal <span class="attribute">age</span>=7 <span class="attribute">idle</span>=1 MS#4,<span class="attribute">TLLI</span>=c002b001 <span class="attribute">IPs</span>=192.168.99.1</span><br></pre></td></tr></table></figure>

<h2 id="0x440-故障排除"><a href="#0x440-故障排除" class="headerlink" title="0x440 故障排除"></a>0x440 故障排除</h2><p>如果你可以连接但是没得到一个<code>IP</code>地址，可能是因为防火墙的设置。一般这都不是问题，但可能和不同的Linux系统以及<code>IP</code>网络配置有关。可以禁用防火墙再重启<code>OpenBTS</code>服务：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GGSN.Firewall.<span class="builtin-name">Enable</span> 0</span><br><span class="line">GGSN.Firewall.<span class="builtin-name">Enable</span> changed <span class="keyword">from</span> <span class="string">"1"</span> <span class="keyword">to</span> <span class="string">"0"</span></span><br><span class="line">GGSN.Firewall.<span class="builtin-name">Enable</span> is static; change takes effect on restart</span><br></pre></td></tr></table></figure>

<p>手机联网还会通过<code>OpenBTS</code>检测你的<code>DNS</code>服务器，如果发现你的手机无法解析域名，请尝试手动设置<code>DNS</code>服务器并重启<code>OpenBTS</code>服务：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GGSN.DNS 8.8.8.8</span><br><span class="line">GGSN.DNS changed <span class="keyword">from</span> <span class="string">""</span> <span class="keyword">to</span> <span class="string">"8.8.8.8"</span></span><br><span class="line">GGSN.DNS is static; change takes effect on restart</span><br></pre></td></tr></table></figure>

<p><code>网关GPRS支持节点(GGSN)</code>和<code>服务GPRS支持节点()</code>在常规<code>GSM</code>网络中是分离的，但在这里是被直接嵌入到<code>OpenBTS</code>中的。为了更深入的了解这些组件中的发生的事情，可以配置一个独立的日志文件，用来观察网络中手机和<code>GPRS</code>服务的交互。将<code>GGSN.Logfile.Name</code>键值设置为你将要写入的日志文件的路径，然后重启<code>OpenBTS</code>服务：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; devconfig GGSN.Logfile.Name /tmp/GGSN.<span class="keyword">log</span></span><br><span class="line">GGSN.Logfile.Name changed <span class="keyword">from</span> "" <span class="keyword">to</span> "/tmp/GGSN.log"</span><br><span class="line">GGSN.Logfile.Name <span class="keyword">is</span> static; change takes effect <span class="keyword">on</span> <span class="keyword">restart</span></span><br></pre></td></tr></table></figure>

<p>现在，<code>GPRS</code>网络上的活动都会经过<code>GGSN</code>，新的条目都会记录到这个日志文件，用<code>tail -f</code>命令监控日志文件：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tail -f /tmp/GGSN.log</span><br><span class="line"> <span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:  GGSN.MS.IP.Base=<span class="number">192.168</span><span class="number">.99</span><span class="number">.1</span></span><br><span class="line"> <span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:  GGSN.MS.IP.MaxCount=<span class="number">254</span></span><br><span class="line"> <span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:  GGSN.MS.IP.Route=<span class="number">192.168</span><span class="number">.99</span><span class="number">.0</span>/<span class="number">24</span></span><br><span class="line"> <span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:  GGSN.IP.MaxPacketSize=<span class="number">1520</span></span><br><span class="line"> <span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:  GGSN.IP.ReuseTimeout=<span class="number">180</span></span><br><span class="line"> <span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:  GGSN.Firewall.Enable=<span class="number">0</span></span><br><span class="line"> <span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:  GGSN.IP.TossDuplicatePackets=<span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:GGSN: DNS servers: <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">53</span>:<span class="number">12.3</span>:ip link <span class="keyword">set</span> sgsntun up</span><br><span class="line"><span class="number">16</span>:<span class="number">53</span>:<span class="number">12.6</span>:ip route add to <span class="number">192.168</span><span class="number">.99</span><span class="number">.0</span>/<span class="number">24</span> dev sgsntun</span><br></pre></td></tr></table></figure>

<h2 id="0x450-性能调优"><a href="#0x450-性能调优" class="headerlink" title="0x450 性能调优"></a>0x450 性能调优</h2><p><code>OpenBTS</code>尝试智能划分资源分配给信令用的<code>独立专用控制信道(SDCCH)</code>和媒体用的<code>业务信道(TCH)</code>。但是，它并没有一种用来平衡不同类型<code>TCH</code>用途的机制。</p>
<h3 id="0x451-语音和GPRS"><a href="#0x451-语音和GPRS" class="headerlink" title="0x451 语音和GPRS"></a>0x451 语音和GPRS</h3><p>语音和<code>GPRS</code>流量是用的时隙都是由<code>TCH</code>逻辑信道承载，如果网络要被部署成<code>GPRS</code>服务而不是语音服务，就需要调整<code>GPRS.Channels.Min.C0</code>键值，这个键值指定用于<code>GPRS</code>的<code>TCH</code>时隙的最小数量，默认是<code>2</code>。要查看当前可用信道数目可以用命令：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; load</span><br><span class="line"><span class="section">== GSM ==</span></span><br><span class="line">SDCCH load/available: 0/4</span><br><span class="line">TCH/F load/available: 0/5</span><br><span class="line">PCH load: active, total: 0, 0</span><br><span class="line">AGCH load: active, pending: 0, 0</span><br><span class="line"><span class="section">== GPRS ==</span></span><br><span class="line">current PDCHs: 2</span><br><span class="line">utilization: 0%</span><br></pre></td></tr></table></figure>

<p>在这里我们可以看到，一共有<code>7</code>个<code>TCH</code>信道可供选择：<code>5</code>个用于<code>GSM</code>语音(GSM:TCH/F)和<code>2</code>个用于<code>GPRS</code>数据(GPRS:PDCHs)。为了最大限度的提高网络的<code>GPRS</code>优先级，将<code>GPRS.Channels.Min.C0</code>设置为<code>TCH</code>信道的最大数量<code>7</code>，然后重启<code>OpenBTS</code>服务：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>GPRS.Channels.Min.C0 7</span><br><span class="line">GPRS.Channels.Min.C0 changed <span class="keyword">from</span> <span class="string">"2"</span> <span class="keyword">to</span> <span class="string">"7"</span></span><br><span class="line">GPRS.Channels.Min.C0 is static; change takes effect on restart</span><br></pre></td></tr></table></figure>

<p>重新执行<code>load</code>命令，可以看到所有的<code>TCH</code>信道都被分配给了<code>GPRS</code>：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt; load</span><br><span class="line"><span class="section">== GSM ==</span></span><br><span class="line">SDCCH load/available: 0/4</span><br><span class="line">TCH/F load/available: 0/0</span><br><span class="line">PCH load: active, total: 0, 0</span><br><span class="line">AGCH load: active, pending: 0, 0</span><br><span class="line"><span class="section">== GPRS ==</span></span><br><span class="line">current PDCHs: 7</span><br><span class="line">utilization: 0%</span><br></pre></td></tr></table></figure>

<p><code>OpenBTS</code>允许你在手动调整时候修改所有的时隙分配，你可以调整<code>组合1(TCH)</code>和<code>组合7(SDCCH)</code>时隙的数量配比，还可以调整这些时隙的顺序，并且其中<code>GPRS</code>时隙应该出现在多<code>ARFCN</code>系统中，查看所有键值搜索<code>Channels</code>：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">Channels</span></span><br><span class="line"><span class="selector-tag">GPRS</span><span class="selector-class">.Channels</span><span class="selector-class">.Min</span><span class="selector-class">.C0</span> 2     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GPRS</span><span class="selector-class">.Channels</span><span class="selector-class">.Min</span><span class="selector-class">.CN</span> 0     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Channels</span><span class="selector-class">.C1sFirst</span> 0     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Channels</span><span class="selector-class">.NumC1s</span> <span class="selector-tag">auto</span>     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Channels</span><span class="selector-class">.NumC7s</span> <span class="selector-tag">auto</span>     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GSM</span><span class="selector-class">.Channels</span><span class="selector-class">.SDCCHReserve</span> 0     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<h3 id="0x452-单一手机吞吐量"><a href="#0x452-单一手机吞吐量" class="headerlink" title="0x452 单一手机吞吐量"></a>0x452 单一手机吞吐量</h3><p>多个手机可以会使用多于1个时隙同时访问<code>GPRS</code>网络，支持上行链路和下行链路的并行时隙的数量被策划那个做<code>多时隙等级</code>。默认情况下，<code>OpenBTS</code>设置的多时隙等级为<code>3+2</code>：3个并行时隙用于下行链路2个用于上行链路。这不是说一个手机会占用全部5个并行时隙，但你可以看到添加尽可能多的时隙对于以<code>GPRS</code>为重点的网络是很重要的。更高的多时隙等级可以给一个手机更快的数据传输速度，但在多个手机使用时网络会很快的拥堵。</p>
<p>你可以调整这两个键值来调整多时隙等级：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Multislot</span><br><span class="line">GPRS.Multislot.Max.Downlink 3     [default]</span><br><span class="line">GPRS.Multislot.Max.Uplink 2     [default]</span><br></pre></td></tr></table></figure>

<h3 id="0x453-覆盖范围和吞吐量"><a href="#0x453-覆盖范围和吞吐量" class="headerlink" title="0x453 覆盖范围和吞吐量"></a>0x453 覆盖范围和吞吐量</h3><p><code>GPRS</code>定义了四种不同的<code>编码方案(CSs)</code>用于数据传输，它们分别是<code>CS1，CS2，CS3和CS4</code>。CS1具有最低的吞吐量和最高的可靠性，它被分配了更多的数据比特用于恢复无线传输过程中的误差。而CS4具备最高的吞吐量，但在传输过程中容易出差错。这些传输误码率限制了每个编码方案的覆盖范围。</p>
<p><code>OpenBTS</code>只支持<code>CS1</code>和<code>CS4</code>，你可以选择配制成低吞吐但可靠性高并且可以覆盖更大范围，还是高吞吐但有少量错误修正并且覆盖范围小。默认情况下<code>OpenBTS</code>同时启动，但它们可以在上行链路或者下行链路单独进行调整：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">devconfig</span> <span class="selector-tag">Codecs</span></span><br><span class="line"><span class="selector-tag">GPRS</span><span class="selector-class">.Codecs</span><span class="selector-class">.Downlink</span> 1,4     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">GPRS</span><span class="selector-class">.Codecs</span><span class="selector-class">.Uplink</span> 1,4     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<h3 id="0x454-预期"><a href="#0x454-预期" class="headerlink" title="0x454 预期"></a>0x454 预期</h3><p><code>GPRS</code>网速不快，但毕竟是数据，在没有<code>WiFi</code>的地方，很大一部分区域都在用调制解调器的速度上网，不管是用于<code>M2M/IOT</code>设备还是人们用来和亲戚朋友联系。一台手机的预期吞吐量如下表：</p>
<figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">多时隙等级和编码方案吞吐量</span><br><span class="line">Slots down+up    <span class="number">1</span>+<span class="number">1</span>                <span class="number">2</span>+<span class="number">1</span>                <span class="number">2</span>+<span class="number">2</span>            <span class="number">3</span>+<span class="number">2</span></span><br><span class="line">CS1            <span class="number">9.05</span>/<span class="number">9.05</span> kbps    <span class="number">18.1</span>/<span class="number">9.05</span> kbps    <span class="number">18.1</span>/<span class="number">18.1</span> kbps    <span class="number">27.15</span>/<span class="number">18.1</span> kbps</span><br><span class="line">CS4            <span class="number">21.4</span>/<span class="number">21.4</span> kbps    <span class="number">42.8</span>/<span class="number">21.4</span> kbps    <span class="number">42.8</span>/<span class="number">42.8</span> kbps    <span class="number">64.2</span>/<span class="number">42.8</span> kbps</span><br></pre></td></tr></table></figure>

<p>这是最佳吞吐量，依赖于网络阻塞情况，包括无线局域网传输和互联网上行链路。</p>
<p>不可否认，<code>OpenBTS</code>对<code>GPRS</code>的支持还不完善。<code>GSM</code>语音和短信对于<code>OpenBTS</code>的用途基本算<code>完善</code>，但<code>GPRS</code>还可以做改进和优化。大多数改进都是在无线电方面的算法及分包规则，对这些的优化能极大的改善<code>OpenBTS</code>中的<code>GPRS</code>的体验。</p>
<h1 id="开放注册"><a href="#开放注册" class="headerlink" title="开放注册"></a>开放注册</h1><p><code>OpenRegistration</code>是<code>OpenBTS</code>的一个特殊功能，相当于移动网络用的<code>强制网络认证</code>。<code>强制网络认证</code>就类似于机场或者酒店的公共WiFi，一般都不能直接用来上网，直到回答一个问题、看一个广告或者输入<code>Pin</code>码才行。</p>
<p>同样的，<code>OpenRegistration</code>允许一个手机加入到移动网络，但担忧初始的访问限制。它可能可以拨出电话但没有分配的号码，所以不能不能被网络中的其他手机呼通，但它可以通过短信来提供它自己的号码。</p>
<p>这种类型的点对点网络非常有用，在任何用户都是临时的或者流动性大的网络或者直接就是临时网络，比如应急响应、远程办公区、旅游景区、大型活动等等。</p>
<p>由于管理员不需要创建用户分配号码，所以<code>OpenRegistration</code>网络更容易部署并且对于用户很有用。</p>
<h2 id="0x510-启用"><a href="#0x510-启用" class="headerlink" title="0x510 启用"></a>0x510 启用</h2><p>要开始使用一个<code>OpenRegistration</code>网络，必须先启用这个功能，先看看键值参数：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">config</span> <span class="selector-tag">OpenRegistration</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span> (<span class="selector-tag">disabled</span>)     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span><span class="selector-class">.Message</span> <span class="selector-tag">Welcome</span> <span class="selector-tag">to</span> <span class="selector-tag">the</span> <span class="selector-tag">test</span> <span class="selector-tag">network</span>.  <span class="selector-tag">Your</span> <span class="selector-tag">IMSI</span> <span class="selector-tag">is</span>      <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span><span class="selector-class">.Reject</span> (<span class="selector-tag">disabled</span>)     <span class="selector-attr">[default]</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span><span class="selector-class">.ShortCode</span> 101     <span class="selector-attr">[default]</span></span><br></pre></td></tr></table></figure>

<p>要启用<code>OpenRegistration</code>，<code>Control.LUR.OpenRegistration</code>键值必须设置成正则表达式。正则表达式是通过定义规则进行匹配的。对于这些有几个标准，更多的信息可以在维基百科中找到。<code>IMSI</code>如果符合正则表达式的匹配就能获得网络的访问权限。几个范例和它们的作用如下表：</p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445686.png" alt=""></p>
<p>按照这个表，<code>OpenRegistration</code>可以接受它所遇到的任何<code>IMSI</code>访问：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.OpenRegistration .*</span><br><span class="line">Control.LUR.OpenRegistration changed <span class="keyword">from</span> <span class="string">""</span> <span class="keyword">to</span> <span class="string">".*"</span></span><br></pre></td></tr></table></figure>

<p>有一个附加键值，可以拒绝特定的<code>IMSI</code>，这样可以很方便的许可除特定组之外所有的<code>IMSI</code>。按照上表设置排除l来自中国移动的任何<code>IMSI</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.OpenRegistration.Reject ^46002</span><br><span class="line">Control.LUR.OpenRegistration.Reject changed <span class="keyword">from</span> <span class="string">""</span> <span class="keyword">to</span> <span class="string">"^46002"</span></span><br></pre></td></tr></table></figure>

<p><strong>注意：确保在野外部署时候，确信你了解这些模式是如何工作。噩梦般的情况是，有个患有心脏病的人无意之间加入了你的开放网络，心脏病发作时候不能拨打紧急服务，因为你的网络不支持。仔细检查你的网络的<code>GSM.RACH.AC</code>的值仍旧是默认的<code>0x400</code>，这会在你的信号塔标识出<code>不支持紧急呼救电话(Emergency Calls Not Supported)</code>。</strong></p>
<h2 id="0x520-个性化"><a href="#0x520-个性化" class="headerlink" title="0x520 个性化"></a>0x520 个性化</h2><p>用户加入你的网络会得到内容为<code>Control.LUR.Open Registration.Message</code>键值的迎接，你可以用下面的命令改变：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OpenBTS&gt;<span class="built_in"> config </span>Control.LUR.OpenRegistration.Message Welcome <span class="keyword">to</span> IslandNet! Call <span class="keyword">or</span> text 101 <span class="keyword">for</span> assistance. Your IMSI is:</span><br><span class="line">Control.LUR.OpenRegistration.Message changed <span class="keyword">from</span> <span class="string">"Welcome to the test network. Your IMSI is "</span> <span class="keyword">to</span> <span class="string">"Welcome to IslandNet! Call or text 101 for assistance. Your IMSI is: "</span></span><br></pre></td></tr></table></figure>

<p>这指示新加入的成员通过拨打<code>101</code>寻求帮助，你的网络应该有一个人分配到<code>101</code>号码提供人工服务或者实现一个自助语音服务。用户也可以按照提示发送号码的短信给<code>101</code>。默认情况下<code>SMQueue</code>服务有一个处理短号<code>101</code>，用来和想要分配自己想要号码的手机进行对话。在<code>SMQueue</code>服务的控制参数中，<code>SC.Register.*</code>参数决定用哪个短号、短信内容以及用户选好范围。<code>SMQueue</code>服务没有在<code>CLI</code>界面，但<code>nmcli.py</code>可以用于读取和修改这些参数：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py smqueue<span class="built_in"> config </span>read</span><br><span class="line">./nmcli.py smqueue<span class="built_in"> config </span>update Configuration.Key.Name new-value</span><br></pre></td></tr></table></figure>

<p>如果你想用特殊号码比如<code>101</code>，就得在<code>OpenBTS</code>中的将<code>Control.LUR.OpenRegistration.ShortCode</code>设成新的号码。这个键值设置了欢迎短信的源地址。如果已经设置到新的帮助号码，用户可以简单的回复初始化信息。</p>
<h2 id="0x530-禁用"><a href="#0x530-禁用" class="headerlink" title="0x530 禁用"></a>0x530 禁用</h2><p>要再次禁用<code>OpenRegistration</code>，接受和拒绝模式设置必须复位：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">unconfig</span> <span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span> <span class="selector-tag">disabled</span></span><br><span class="line"><span class="selector-tag">OpenBTS</span>&gt; <span class="selector-tag">unconfig</span> <span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span><span class="selector-class">.Reject</span></span><br><span class="line"><span class="selector-tag">Control</span><span class="selector-class">.LUR</span><span class="selector-class">.OpenRegistration</span><span class="selector-class">.Reject</span> <span class="selector-tag">disabled</span></span><br></pre></td></tr></table></figure>

<p><code>OpenBTS</code>现在已经恢复使用用户数据库授权或者拒绝用户访问，而不是<code>IMSI</code>模式。</p>
<h1 id="NodeManager-APIs"><a href="#NodeManager-APIs" class="headerlink" title="NodeManager APIs"></a>NodeManager APIs</h1><p><code>NodeManager</code>是一个面对<code>OpenBTS，SMQueue，SIPAuthServe</code>的通用控制接口，用于系统配置和监控。所有的组件都支持一些常用的功能(比如配置操作)，通过提供用于特定任务或者数据源的特定<code>API</code>接口。<code>NodeManager API</code>分成两大类：请求/响应和流。这两种类型都使用<code>JSON</code>格式信息并通过<code>ZeroMQ</code>进行通信，有一个库用来创建这两个进程之间简单和可靠的socket连接。使用<code>NodeManager API</code>是用来简化远程管理多个<code>OpenBTS</code>实例，就像<code>SMQueue</code>和<code>SIPAuthServe</code>那样的中控服务。</p>
<p><code>API</code>是互联网的一个正常组成部分，所以看起来不是那么新奇，不管怎样，后面讲到<code>PhysicalStatus API</code>时候记住前面传统GSM通信原理图。不用去看几十页的协议和实例，软件无线电的核心数据现在可以直接使用<code>JSON</code>格式信息流。在以后的版本中会有更多的<code>API</code>添加到<code>NodeManager</code>接口中。</p>
<h2 id="0x610-nmcli-py"><a href="#0x610-nmcli-py" class="headerlink" title="0x610 nmcli.py"></a>0x610 nmcli.py</h2><p>这个名叫<code>nmcli.py</code>是一个包含在<code>NodeManager</code>库中的一个小的<code>Python</code>程序。它需要安装一些依赖关系，在<code>build.sh</code>脚本中应该已经做了。为了确保你已经安装了，可以再手动执行一遍命令：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">add</span>-apt-repository -<span class="keyword">y</span> <span class="keyword">pp</span><span class="variable">a:chris</span>-lea/zeromq</span><br><span class="line">apt-<span class="built_in">get</span> <span class="keyword">update</span></span><br><span class="line">apt-<span class="built_in">get</span> install libzmq3-dev libzmq3 <span class="keyword">python</span>-zmq</span><br></pre></td></tr></table></figure>

<p><code>nmcli.py</code>用于不断扩展新的<code>NodeManager API</code>的实施。要看当前<code>nmcli.py</code>的功能，执行不带任何参数的命令：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span>  ~<span class="string">/dev/NodeManager</span></span><br><span class="line"><span class="string">./nmcli.py</span></span><br></pre></td></tr></table></figure>

<p><code>nmcli.py</code>的实施效用并不像一个专业的<code>NodeManager API</code>接口，更像一个开发工具，可以快速格式化消息以及测试新的<code>API</code>端点。本章将会讲述各种不同的<code>API</code>端点。首先，<code>nmcli.py</code>用法类似一个清单，随后转换成<code>JSON</code>格式的消息。</p>
<h2 id="0x620-API版本"><a href="#0x620-API版本" class="headerlink" title="0x620 API版本"></a>0x620 API版本</h2><p>所有组件的实施版本，一个请求/响应的<code>API</code>。这是一个微不足道的<code>API</code>，但对于在远程节点上运行的组件来说，这个信息非常重要：它的当前版本。用<code>nmcli.py</code>问询<code>SMQueue</code>当前版本：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py smqueue version</span><br><span class="line">raw request: &#123;<span class="string">"command"</span>:<span class="string">"version"</span>,<span class="string">"action"</span>:<span class="string">""</span>,<span class="string">"key"</span>:<span class="string">""</span>,<span class="string">"value"</span>:<span class="string">""</span>&#125;</span><br><span class="line">raw response: &#123;</span><br><span class="line">        <span class="string">"code"</span> : 200,</span><br><span class="line">        <span class="string">"data"</span> : <span class="string">"release 5.0-master built 2015-01-23T01:49:55 df1e2310f5 CommonLibs:11d8baa826 "</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x630-配置API"><a href="#0x630-配置API" class="headerlink" title="0x630 配置API"></a>0x630 配置API</h2><p>所有的组件的配置实现，都是通过请求/响应<code>API</code>，这个<code>API</code>用于修改每个组件的配置参数。每个组件的配置模式生效之前，都会通过这个<code>API</code>更新对应<code>SQLite3</code>数据库中对应值。</p>
<h2 id="0x640-查看所有键值"><a href="#0x640-查看所有键值" class="headerlink" title="0x640 查看所有键值"></a>0x640 查看所有键值</h2><p>使用<code>nmcli.py</code>询问<code>SMQueue</code>所有可配置选项：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py smqueue<span class="built_in"> config </span>read</span><br></pre></td></tr></table></figure>

<p>会请求一个<code>config</code>命令和<code>read</code>行为：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raw <span class="string">request:</span> &#123;<span class="string">"command"</span>:<span class="string">"config"</span>,<span class="string">"action"</span>:<span class="string">"read"</span>,<span class="string">"key"</span>:<span class="string">""</span>,<span class="string">"value"</span>:<span class="string">""</span>&#125;</span><br></pre></td></tr></table></figure>

<p>之后<code>SMQueue</code>会响应它所支持的每个配置项的很大的支持列表：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">raw response: &#123;</span><br><span class="line">        <span class="string">"code"</span> : 200,</span><br><span class="line">        <span class="string">"data"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x650-查看某一个键值"><a href="#0x650-查看某一个键值" class="headerlink" title="0x650 查看某一个键值"></a>0x650 查看某一个键值</h2><p>这个<code>API</code>还支持低于特定一个键值，用<code>nmcli.py</code>询问<code>SMQueue</code>中<code>SC.Register.Code</code>键值：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py smqueue<span class="built_in"> config </span>read SC.Register.Code</span><br></pre></td></tr></table></figure>

<p>会请求一个<code>config</code>命令和<code>read</code>行为，还有一个新的键值字段<code>SC.Register.Code</code>：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raw <span class="string">request:</span> &#123;<span class="string">"command"</span>:<span class="string">"config"</span>,<span class="string">"action"</span>:<span class="string">"read"</span>,<span class="string">"key"</span>:<span class="string">"SC.Register.Code"</span>,<span class="string">"value"</span>:<span class="string">""</span>&#125;</span><br></pre></td></tr></table></figure>

<p>之后<code>SMQueue</code>会响应这个特定键值的关键配置项和参数信息：</p>
<figure class="highlight smalltalk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">raw response: &#123;</span><br><span class="line">        <span class="comment">"code"</span> : <span class="number">200</span>,</span><br><span class="line">        <span class="comment">"data"</span> : &#123;</span><br><span class="line">                <span class="comment">"defaultValue"</span> : <span class="comment">"101"</span>,</span><br><span class="line">                <span class="comment">"description"</span> : <span class="comment">"Short code to the application which registers the sender to the system."</span>,</span><br><span class="line">                <span class="comment">"key"</span> : <span class="comment">"SC.Register.Code"</span>,</span><br><span class="line">                <span class="comment">"scope"</span> : <span class="number">0</span>,</span><br><span class="line">                <span class="comment">"static"</span> : <span class="keyword">false</span>,</span><br><span class="line">                <span class="comment">"type"</span> : <span class="comment">"string"</span>,</span><br><span class="line">                <span class="comment">"units"</span> : <span class="comment">""</span>,</span><br><span class="line">                <span class="comment">"validValues"</span> : <span class="comment">"^[0-9]&#123;3,6&#125;$"</span>,</span><br><span class="line">                <span class="comment">"value"</span> : <span class="comment">"101"</span>,</span><br><span class="line">                <span class="comment">"visibility"</span> : <span class="comment">"customer - can be freely changed by the customer without any detriment to their system"</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果这个键值的请求不存在，会从组件中响应一个404返回。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">"code"</span> : <span class="number">404</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="0x660-更新"><a href="#0x660-更新" class="headerlink" title="0x660 更新"></a>0x660 更新</h2><p>如果一个<code>API</code>配置不允许设置新的参值，那就没有用处。一个消息字段变更为<code>更新</code>，那么这个新的键值字段的更新必定包含所指定的改变。用<code>nmcli.py</code>更新前面所说的<code>SC.Register.Code</code>键值从<code>101为</code>555`，</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py smqueue<span class="built_in"> config </span>update SC.Register.Code 555</span><br></pre></td></tr></table></figure>

<p>注意新的值有更新行为：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">raw <span class="string">request:</span> &#123;<span class="string">"command"</span>:<span class="string">"config"</span>,<span class="string">"action"</span>:<span class="string">"update"</span>,<span class="string">"key"</span>:<span class="string">"SC.Register.Code"</span>,<span class="string">"value"</span>:<span class="string">"555"</span>&#125;</span><br></pre></td></tr></table></figure>

<p>响应包括两条信息：</p>
<figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">raw response: &#123;</span><br><span class="line">        <span class="string">"code"</span> : 204,</span><br><span class="line">        <span class="string">"dirty"</span> : 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>204</code>代码表示操作成功但没有数据反馈。这个例子告诉你没有那个应用的配置是全静态的，你的配置是灵活的。如果配置不为0，那么该组件需要重启才能应用更改。以下是其他反馈代码和含义：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">304: nothing to <span class="keyword">change</span>, <span class="keyword">old</span> <span class="keyword">and</span> <span class="keyword">new</span> <span class="keyword">values</span> <span class="keyword">match</span></span><br><span class="line"><span class="number">404</span>: <span class="literal">unknown</span> <span class="keyword">key</span> (just <span class="keyword">like</span> the <span class="keyword">read</span> command)</span><br><span class="line"><span class="number">406</span>: <span class="keyword">new</span> <span class="keyword">value</span> <span class="keyword">is</span> invalid</span><br><span class="line"><span class="number">409</span>: <span class="keyword">new</span> <span class="keyword">value</span> conflicts <span class="keyword">with</span> another configuration <span class="keyword">key</span></span><br><span class="line"><span class="number">500</span>: <span class="keyword">database</span> <span class="keyword">error</span>, storing the <span class="keyword">new</span> <span class="keyword">value</span> <span class="keyword">failed</span></span><br></pre></td></tr></table></figure>

<h2 id="0x670-物理状态API"><a href="#0x670-物理状态API" class="headerlink" title="0x670 物理状态API"></a>0x670 物理状态API</h2><p><code>OpenBTS</code>只有一个<code>API</code>流来实现<code>PhysicalStatus</code>组件。默认情况下它是不生效的。使用<code>NodeManager.API.PhysicalStatus</code>键值启用它。为了确保向后兼容，<code>PhysicalStatus API</code>支持不同的释放模式。目前只支持<code>0.1</code>，设置这个键值<code>0.1</code>将会激活<code>PhysicalStatus API</code>并使用<code>0.1</code>模式的流事件数据。现在你已经可以熟练使用<code>nmcli.py</code>，就可以激活这个<code>API</code>：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nmcli.py openbts<span class="built_in"> config </span>update NodeManager.API.PhysicalStatus 0.1</span><br></pre></td></tr></table></figure>

<p>流激活以后，你需要连接客户端查看所产生的数据。在<code>OpenBTS</code>的<code>apps</code>目录有一个名为<code>JSONEventsClient.cpp</code>的样例客户端。在编译<code>OpenBTS</code>时候会默认被编译，但在安装包的时候没有安装进系统。这个客户端会连接由<code>NodeManager.Events.Port</code>定义的<code>ZeroMQ</code>端口，然后等待<code>API</code>发布事件。</p>
<p>进入你的<code>OpenBTS</code>源码目录然后进入<code>client</code>所在目录：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cd</span> dev/openbts/apps</span><br><span class="line"><span class="string">./JSONEventsClient</span></span><br></pre></td></tr></table></figure>

<p>没有什么特殊的情况发生，直到你的<code>OpenBTS</code>有活动。</p>
<p>在手机上循环关机，发短信或者打电话，<code>PhysicalStatus</code>就会开始在控制台显示活动情况。举个例子如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">        <span class="attr">"data"</span> : &#123;</span><br><span class="line">                <span class="attr">"burst"</span> : &#123;</span><br><span class="line">                        <span class="attr">"RSSI"</span> : <span class="number">-13.875</span>,</span><br><span class="line">                        <span class="attr">"RSSP"</span> : <span class="number">-13.875</span>,</span><br><span class="line">                        <span class="attr">"actualMSPower"</span> : <span class="number">33</span>,</span><br><span class="line">                        <span class="attr">"actualMSTimingAdvance"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"timingError"</span> : <span class="number">0.0673828</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"channel"</span> : &#123;</span><br><span class="line">                        <span class="attr">"ARFCN"</span> : <span class="number">51</span>,</span><br><span class="line">                        <span class="attr">"IMSI"</span> : <span class="string">"no-MMUser"</span>,</span><br><span class="line">                        <span class="attr">"carrierNumber"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"timeslotNumber"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="attr">"typeAndOffset"</span> : <span class="string">"SDCCH/4-0"</span>,</span><br><span class="line">                        <span class="attr">"uplinkFrameErrorRate"</span> : <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="attr">"reports"</span> : &#123;</span><br><span class="line">                        <span class="attr">"neighboringCells"</span> : [],</span><br><span class="line">                        <span class="attr">"servingCell"</span> : &#123;</span><br><span class="line">                                <span class="attr">"RXLEVEL_FULL_dBm"</span> : <span class="number">-77</span>,</span><br><span class="line">                                <span class="attr">"RXLEVEL_SUB_dBm"</span> : <span class="number">-77</span>,</span><br><span class="line">                                <span class="attr">"RXQUALITY_FULL_BER"</span> : <span class="number">0</span>,</span><br><span class="line">                                <span class="attr">"RXQUALITY_SUB_BER"</span> : <span class="number">0</span></span><br><span class="line">                        &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">"name"</span> : <span class="string">"PhysicalStatus"</span>,</span><br><span class="line">        <span class="attr">"timestamp"</span> : <span class="string">"1174698439"</span>,</span><br><span class="line">        <span class="attr">"version"</span> : <span class="string">"0.1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这些输出显示了手机和基站之间业务流的物理无线电脉冲信息。这些输出作为<code>GSM</code>标准的一部分在后台生成，也被称为<code>测量报告</code>。它们提供了手机调整发送功率所需的基站信息、触发切换的信息以及计算定时提前量<code>Timing Advance</code>。</p>
<p>那么，这些数据的价值在哪里？很多应用可以利用这些网络的无线电环境的原始元信息，来做出更智能的电力功耗决策，负载均衡等等。</p>
<p>这个目前被用于搜救行动，冰岛的直升机已经配备了运行<code>OpenBTS</code>的便携基站，运到没有信号的偏远地区用来寻找迷路的徒步旅行者。<code>OpenRegistration</code>配置为允许该地区所有的手机自动加入网络，网络通过发出的测试短信不断的记录基站和手机的无线电接收等级和发射功率都。和无线电信息一起的还有经度、纬度和高度值都被直升机记录下来。然后这些信息通过算法进行分析，可以<code>65m</code>精度在高达<code>35km</code>区域内定位任何手机。更多的项目相关信息可以在<code>http://bit.ly/11vKaT7</code>找到。</p>
<h1 id="步步高升"><a href="#步步高升" class="headerlink" title="步步高升"></a>步步高升</h1><p>希望你已经看完这本书，成功实现了你所感兴趣的领域。这里还有一些出发点用于进一步的研究和实验。</p>
<h2 id="0x710-连接到外面的世界"><a href="#0x710-连接到外面的世界" class="headerlink" title="0x710 连接到外面的世界"></a>0x710 连接到外面的世界</h2><p>连接你的手机与外界”真实”的电话，您需要一个<code>网络电话业务提供商(ITSP)</code>，<code>ITSP</code>可以桥接你网络中的<code>SIP</code>信令和RTP媒体到他们的<code>PSTN</code>。</p>
<h2 id="0x720-语音"><a href="#0x720-语音" class="headerlink" title="0x720 语音"></a>0x720 语音</h2><p>找到<code>ITSP</code>的语音服务很简单，现在这些提供按分钟包月通话服务的公司网上都有目录。<code>入网手机号</code>或者<code>直拨入网电话(DID)</code>，全世界大部分国家都提供这项服务。许多公司还提供了<code>Asterisk</code>服务安装及使用技术支持。</p>
<h2 id="0x730-短信"><a href="#0x730-短信" class="headerlink" title="0x730 短信"></a>0x730 短信</h2><p>短信的支持比较困难，很少有<code>ITSP</code>提供<code>SIP MESSAGE</code>用于短信服务。供应商提供这种服务也一般不会提供配对的语音<code>DID</code>,这样一个手机会有不同的电话号码用于打电话和发短信。这种情况正在改善，但现在需要替代方案。</p>
<p>有的供应商会提供<code>SMPP</code>网关或者<code>HTTP REST API</code>接口网关，再或者，有些<code>DID</code>无法使用或者需要额外的<code>SIP MESSAGE</code>连接。</p>
<p>一个比较成功的使用<code>API</code>的案例是<code>nexmo</code>。</p>
<h2 id="0x740-频谱规则"><a href="#0x740-频谱规则" class="headerlink" title="0x740 频谱规则"></a>0x740 频谱规则</h2><p>这是这本书无法解决的问题之一，无线电管制具备法律有效性。虽然历来获得无线电频率许可的都是通信巨头，但现在这个情况开始有所改变。监管部门的压力在于要将可用频段划分的更细，然后分配给各自需要使用的领域。</p>
<p>频谱政策最有前卫的似乎是欧洲。英国，荷兰和瑞典已经将最有价值的几个<code>ARFCN</code>频段分配给公众使用，其中包括<code>GSM</code>频段。任何人在没有执照的情况下都可以在有限的功率下使用这些频率。美国<code>FCC</code>似乎有计划在2015年拍卖大量频谱，并将放出高达<code>28MHz</code>的保护频段可以在特定区域随意使用，比如<code>动态频谱联盟(Dynamic Spectrum Alliance)</code>这样的团体对<code>GSM</code>空白研究活动，从政治上或者技术上解决频谱接入问题。</p>
<h2 id="0x750-切换调整"><a href="#0x750-切换调整" class="headerlink" title="0x750 切换调整"></a>0x750 切换调整</h2><p><code>OpenBTS</code>正在使用标准的<code>SIP</code>信令也需要，很必要，主要用来替换<code>GSM</code>和<code>UMTS</code>认证算法替代<code>MD5</code>。</p>
<p>到目前为止，整合一直在开始第一步，但已经在努力加快步伐。<code>OpenBTS</code>中的<code>Asterisk</code>和<code>FreeSWITCH</code>打过补丁后直接支持注册和语音呼叫，这个都已经写入各自的项目阶段。<code>Kazoo</code>平台<code>(http://wiki.2600hz.org)</code>已经拥有最完整的支持，注册、语音和短信都能正常运行。</p>
<h2 id="0x760-3G数据"><a href="#0x760-3G数据" class="headerlink" title="0x760 3G数据"></a>0x760 3G数据</h2><p><code>OpenBTS-UMTS 1.0</code>已经在2014年10月份发布，这是我们所知道的第一个<code>UMTS</code>开源堆栈，添加了<code>3G</code>的数据传输速度，对于这个新的<code>混合网络</code>的功能列表，更多信息请查看<code>http://openbts.org/w/index.php/OpenBTS-UMTS</code></p>
<h2 id="0x770-开源硬件"><a href="#0x770-开源硬件" class="headerlink" title="0x770 开源硬件"></a>0x770 开源硬件</h2><p>如果你是一个硬件设计师并且很好奇<code>SDR</code>是怎么做的，那你很幸运，你不仅仅是在使用开源软件来构建移动网络，他们还在设计开源硬件。好几种<code>SDR</code>的原理图都是完全开放的，在他们的GitHub上：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">Fairwaves</span> <span class="string">UmTRX</span></span><br><span class="line"><span class="attr">HackRF</span></span><br><span class="line"><span class="attr">Range</span> <span class="string">Networks RAD1/SDR1</span></span><br></pre></td></tr></table></figure>

<h2 id="0x780-社区"><a href="#0x780-社区" class="headerlink" title="0x780 社区"></a>0x780 社区</h2><p>·OpenBTS·社区可以提供很多学科方面的专业支持，可以订阅邮件列表。参加者有很多不同的背景：制造商、黑客、研究员还有集成商都很受欢迎。</p>
<h2 id="0x790-革命"><a href="#0x790-革命" class="headerlink" title="0x790 革命"></a>0x790 革命</h2><p>现代化移动网络应该是什么样子，是不是设计成一个标准的互联网世界？我们开始意识到这个问题的答案：极度简化，极其灵活，开放所有的新思路，极少的花费。</p>
<p>这是第一次，普通人可以下载一些软件，然后拿起一台无线电设备，就可以建立一个移动网络。欢迎一起革命！</p>
<h1 id="快速参考"><a href="#快速参考" class="headerlink" title="快速参考"></a>快速参考</h1><p>下面是分散在书中很多实例的快速参考。我发现自己在看这些东西的时候不断的想把这些放在一个统一的部分讲讲。</p>
<h2 id="0x810-GSM层次"><a href="#0x810-GSM层次" class="headerlink" title="0x810 GSM层次"></a>0x810 GSM层次</h2><p>这本书不能在短短几章里面教会你·GSM·。但有一个很有用的办法从宏观到微观层面掌握·GSM·术语。</p>
<p>带天线的信号塔大家都很熟悉，有时候伪装成仙人掌或者树桅杆。每个塔都可以分成多个扇区，这些扇区合起来360º(比如一个塔分成4个90º扇区)，单个扇区360º全覆盖。每个扇区都能分配一个或者多个·ARFCN·，有时候也成为载体，因为它们实际一对频率，用于数据进行物理交互。</p>
<p>每个·ARFCN·有8个时隙，每个时隙有分配给它的组合，每个组合有多个逻辑信道。这些逻辑信道被分为信令和媒体两个主要类别。·SDCCH(独立专用控制信道)·用来传送信令，比如手机注册消息和短信消息。·TCH(业务信道)·用来承载媒体，比如·GPRS·数据或者语音消息。逻辑信道是由多个帧信号以及帧信号组成的脉冲构成。</p>
<p>看整个系统的进程，其实就是<code>GSM Timeslot</code>和<code>Channel Visualizer</code>。</p>
<h2 id="0x820-分贝和毫瓦分贝"><a href="#0x820-分贝和毫瓦分贝" class="headerlink" title="0x820 分贝和毫瓦分贝"></a>0x820 分贝和毫瓦分贝</h2><p>分贝用来表述两个值的对比或者单一基站时的绝对值比率。写作·dB·时候只表述一个比率，比如·10dB·的·SNR·意味着信号比噪声强·10x·倍。写作·dBm·时候，表述的是以毫瓦为单位的绝对值，比如·GSM·手机最大发送功率是·33dBm·或者·2W·。</p>
<p>一个很方便的记忆方法是，每出现·3dB·的改变，无线电信号翻倍或者减半。</p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445688.png" alt=""></p>
<p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445689.png" alt=""></p>
<h2 id="0x830-网络端口"><a href="#0x830-网络端口" class="headerlink" title="0x830 网络端口"></a>0x830 网络端口</h2><p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445690.png" alt=""></p>
<h2 id="0x840-文件路径"><a href="#0x840-文件路径" class="headerlink" title="0x840 文件路径"></a>0x840 文件路径</h2><p><img src="https://raw.githubusercontent.com/white-alone/blog_img/master/OpenBTS%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97/1591024445691.png" alt=""></p>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css"><script type="text/javascript" src="/js/donate.js" successtext="复制成功!"></script><a class="pos-f tr3" id="github" href="https://github.com/Kaiyuan/donate-page" target="_blank" rel="noopener" arget="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="PayPal"><a href="https://paypal.me/WhiteA10n3" target="_blank"></a></li><li id="AliPay" qr="/img/AliPayQR.png"></li><li id="WeChat" qr="/img/WeChatQR.png"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="tags"><a href="/tags/%E6%97%A0%E7%BA%BF/"><i class="fa fa-tag"></i>无线</a></div><div class="post-nav"><a class="pre" href="/GNU%20Radio%203.8.0.0%E5%AE%89%E8%A3%85/">GNU Radio 3.8.0.0安装</a><a class="next" href="/Ubuntu%2018.04%E9%85%8D%E7%BD%AEGNURadio%E5%9F%BA%E7%A1%80%E7%8E%AF%E5%A2%83/">Ubuntu 18.04配置GNURadio基础环境</a></div><div id="vcomment"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script><script>var notify = 'false' == 'true' ? true : false;
var verify = 'false' == 'true' ? true : false;
var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
window.valine = new Valine({
  el:'#vcomment',
  notify:notify,
  verify:verify,
  appId:'DMvc4Cxt8whC7d4dX0ysFmXE-gzGzoHsz',
  appKey:'8i8vBc78aHMgXoKi1rz4CzKa',
  placeholder:'Just so so',
  avatar:'mm',
  guest_info:guest_info,
  pageSize:'10'
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://github.white-alone.com"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Home/">Home</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IoT/">IoT</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/IoTCraftsman/">IoTCraftsman</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/PCB/">PCB</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Radio/">Radio</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Windows/">Windows</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/%E6%97%A0%E7%BA%BF/" style="font-size: 15px;">无线</a> <a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/%E9%A9%B1%E5%8A%A8/" style="font-size: 15px;">驱动</a> <a href="/tags/ESXi/" style="font-size: 15px;">ESXi</a> <a href="/tags/MacOS/" style="font-size: 15px;">MacOS</a> <a href="/tags/%E7%A1%AC%E4%BB%B6/" style="font-size: 15px;">硬件</a> <a href="/tags/%E8%BD%AF%E4%BB%B6%E6%97%A0%E7%BA%BF%E7%94%B5/" style="font-size: 15px;">软件无线电</a> <a href="/tags/IoTCraftsman/" style="font-size: 15px;">IoTCraftsman</a> <a href="/tags/Ubuntu/" style="font-size: 15px;">Ubuntu</a> <a href="/tags/Debian/" style="font-size: 15px;">Debian</a> <a href="/tags/%E7%BD%91%E7%AB%99/" style="font-size: 15px;">网站</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 15px;">软件</a> <a href="/tags/Home/" style="font-size: 15px;">Home</a> <a href="/tags/Andriod/" style="font-size: 15px;">Andriod</a> <a href="/tags/Root/" style="font-size: 15px;">Root</a> <a href="/tags/NAS/" style="font-size: 15px;">NAS</a> <a href="/tags/IoT/" style="font-size: 15px;">IoT</a> <a href="/tags/%E7%BD%91%E7%BB%9C/" style="font-size: 15px;">网络</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/%E5%AE%B6%E5%BA%AD%E7%BD%91%E7%BB%9C%E5%8D%87%E7%BA%A7%E6%8C%87%E5%8D%97%E3%80%90%E4%B8%80%E3%80%91/">家庭网络升级指南【一】</a></li><li class="post-list-item"><a class="post-list-link" href="/IoT%20Craftsman%E8%AE%BA%E5%9D%9B%E5%AF%B9%E5%A4%96%E5%85%B3%E9%97%AD/">IoT Craftsman论坛对外关闭</a></li><li class="post-list-item"><a class="post-list-link" href="/Eagle%E7%A7%92%E9%80%80%E9%97%AE%E9%A2%98/">Eagle秒退问题</a></li><li class="post-list-item"><a class="post-list-link" href="/Intel%20X710%E5%92%8CXL710%E8%A7%A3%E9%94%81SFP%E6%A8%A1%E5%9D%97%E9%99%90%E5%AE%9A/">Intel X710和XL710 解锁 SFP模块限定</a></li><li class="post-list-item"><a class="post-list-link" href="/ESXi%207.0U2%E9%A9%B1%E5%8A%A8%E6%B5%B7%E5%BA%B7%E5%A8%81%E8%A7%86C2000%20Pro%E6%96%B9%E6%B3%95/">ESXi 7.0U2驱动海康威视C2000 Pro方法</a></li><li class="post-list-item"><a class="post-list-link" href="/ESXi%20%E5%B0%81%E8%A3%85I219V%E7%BD%91%E5%8D%A1%E9%A9%B1%E5%8A%A8/">ESXi 封装I219V网卡驱动</a></li><li class="post-list-item"><a class="post-list-link" href="/%E4%BD%BF%E7%94%A8BladeRF%E6%88%96%E8%80%85B210%E5%BF%AB%E9%80%9F%E6%9E%84%E5%BB%BA4G%20LTE%E6%B5%8B%E8%AF%95%E7%BD%91/">使用BladeRF或者B210快速构建4G LTE测试网</a></li><li class="post-list-item"><a class="post-list-link" href="/%E5%AE%89%E8%A3%85%E4%BB%BB%E6%84%8F%E7%89%88%E6%9C%ACUHD%E9%A9%B1%E5%8A%A8/">安装任意版本UHD驱动</a></li><li class="post-list-item"><a class="post-list-link" href="/Ubuntu%2020.04%E5%AE%89%E8%A3%85GNURadio/">Ubuntu 20.04安装GnuRadio</a></li><li class="post-list-item"><a class="post-list-link" href="/%E8%BD%AF%E8%B7%AF%E7%94%B1%E9%85%8D%E7%BD%AE/">软路由配置</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://www.t00ls.net/" title="T00ls" target="_blank">T00ls</a><ul></ul><a href="http://unicorn.360.cn/" title="UnicornTeam" target="_blank">UnicornTeam</a><ul></ul><a href="https://www.jarviswang.me/" title="Jarvis" target="_blank">Jarvis</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">White-Alone </a>| <a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/">  京ICP备16029179号-1 </a>| <img class="nofancybox" src="/img/beian.png" style="margin-bottom: -4px;"/><a rel="nofollow" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode= 11010502037135">  京公网安备11010502037135号</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>